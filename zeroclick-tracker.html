// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏Ç‡∏≠ POST ‡∏à‡∏≤‡∏Å LIFF
function doPost(e) {
  try {
    Logger.log("=== doPost STARTED ===");
    Logger.log("Content type: " + e.contentType);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠
    if (e.contentType && e.contentType.includes('multipart/form-data')) {
      // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
      return handleFileUpload(e);
    } else if (e.postData && e.postData.type === 'application/json') {
      // ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON
      const data = JSON.parse(e.postData.contents);
      
      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      if (data.type === 'zeroclick-notification') {
        return handleZeroClickNotification(data);
      } else {
        // ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        return handleExistingPostRequest(e);
      }
    } else {
      // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
      return handleExistingPostRequest(e);
    }
  } catch (error) {
    Logger.log("Error in doPost: " + error.message);
    Logger.log("Stack trace: " + error.stack);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å LIFF
function handleFileUpload(e) {
  try {
    Logger.log("=== handleFileUpload STARTED ===");
    
    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠
    const formData = e.parameter;
    const fileBlob = e.parameter.image;
    const trackingKey = formData.trackingKey || generateZeroClickTrackingKey();
    const caseName = formData.caseName || "ZeroClick";
    const userId = formData.userId || "unknown";
    const displayName = formData.displayName || "unknown";
    
    Logger.log("Tracking Key: " + trackingKey);
    Logger.log("Case Name: " + caseName);
    Logger.log("User ID: " + userId);
    Logger.log("Display Name: " + displayName);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå
    if (!fileBlob) {
      throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
    }
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á trackingKey ‡πÅ‡∏•‡∏∞ caseName
    saveZeroClickMapping(trackingKey, caseName, userId, displayName);
    
    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive
    const imageUrl = uploadImageToDrive(fileBlob, trackingKey);
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°
    const trackingUrl = createZeroClickTrackingUrl(trackingKey);
    
    Logger.log("Image URL: " + imageUrl);
    Logger.log("Tracking URL: " + trackingUrl);
    Logger.log("=== handleFileUpload COMPLETED ===");
    
    // ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á LIFF
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success',
      trackingKey: trackingKey,
      imageUrl: imageUrl,
      trackingUrl: trackingUrl
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log("Error in handleFileUpload: " + error.message);
    Logger.log("Stack trace: " + error.stack);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Zero Click
function handleZeroClickNotification(data) {
  try {
    Logger.log("=== handleZeroClickNotification STARTED ===");
    Logger.log("Data: " + JSON.stringify(data));
    
    const trackingKey = data.trackingKey;
    const event = data.event || "view"; // "view" ‡∏´‡∏£‡∏∑‡∏≠ "gps"
    
    if (!trackingKey) {
      throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö tracking key");
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏™‡∏à‡∏≤‡∏Å tracking key
    const trackingInfo = getZeroClickInfo(trackingKey);
    
    if (!trackingInfo) {
      throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö tracking key: " + trackingKey);
    }
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE
    data.timestamp = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
    data.caseName = trackingInfo.caseName;
    data.creatorId = trackingInfo.creatorId;
    data.creatorName = trackingInfo.creatorName;
    data.creatorFullName = trackingInfo.creatorFullName;
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
    let message;
    if (event === "view") {
      message = createZeroClickViewMessage(data);
    } else if (event === "gps") {
      message = createZeroClickGPSMessage(data);
    } else {
      message = createZeroClickMessage(data); // ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ
    }
    
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE
    sendZeroClickNotification(message, data.creatorId);
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Spreadsheet
    logZeroClickData(data);
    
    Logger.log("=== handleZeroClickNotification COMPLETED ===");
    
    return ContentService.createTextOutput(JSON.stringify({
      status: 'success'
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log("Error in handleZeroClickNotification: " + error.message);
    Logger.log("Stack trace: " + error.stack);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á tracking key ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Zero Click
function generateZeroClickTrackingKey() {
  const timestamp = Date.now().toString(36);
  const randomChars = Math.random().toString(36).substring(2, 6);
  return `zc-${timestamp}-${randomChars}`;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° Zero Click
function createZeroClickTrackingUrl(trackingKey) {
  // ‡∏õ‡∏£‡∏±‡∏ö URL ‡∏ï‡∏≤‡∏°‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  return `https://socialtopnews.github.io/news/zeroclick.html?zc=${trackingKey}`;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Drive
function uploadImageToDrive(fileBlob, trackingKey) {
  try {
    // ID ‡∏Ç‡∏≠‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏ô Google Drive
    const FOLDER_ID = "17232Rx3d7mlH5RqgfMsmuwAhhiFqeQQI"; // ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
    const fileName = `ZeroClick_${trackingKey}_${new Date().toISOString().replace(/[:.]/g, '-')}`;
    
    // ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
    const folder = DriveApp.getFolderById(FOLDER_ID);
    const file = folder.createFile(fileBlob);
    file.setName(fileName);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏ä‡∏£‡πå (‡πÉ‡∏´‡πâ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡πÑ‡∏î‡πâ)
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    // ‡∏£‡∏±‡∏ö URL ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå
    return file.getDownloadUrl();
  } catch (error) {
    Logger.log("Error uploading image to Drive: " + error.message);
    throw error;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á tracking key ‡πÅ‡∏•‡∏∞ case name
function saveZeroClickMapping(trackingKey, caseName, userId, displayName) {
  try {
    Logger.log("=== saveZeroClickMapping STARTED ===");
    Logger.log("trackingKey: " + trackingKey);
    Logger.log("caseName: " + caseName);
    Logger.log("userId: " + userId);
    Logger.log("displayName: " + displayName);
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const spreadsheet = SpreadsheetApp.openById('1j7MqTTEW6izLtVDk95SlPYLjkUqk9MTV7-ZK0Arpnj8');
    let mappingSheet = spreadsheet.getSheetByName('ZeroClickMapping');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ï‡πÉ‡∏´‡∏°‡πà‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    if (!mappingSheet) {
      Logger.log("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ï ZeroClickMapping ‡πÉ‡∏´‡∏°‡πà");
      mappingSheet = spreadsheet.insertSheet('ZeroClickMapping');
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      const headers = ['TrackingKey', 'CaseName', 'CreateDate', 'CreatorId', 'CreatorName', 'CreatorFullName', 'Type'];
      mappingSheet.appendRow(headers);
      
      // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      mappingSheet.getRange(1, 1, 1, headers.length)
        .setBackground('#4285f4')
        .setFontColor('#ffffff')
        .setFontWeight('bold');
      
      // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
      mappingSheet.setColumnWidth(1, 200); // TrackingKey
      mappingSheet.setColumnWidth(2, 250); // CaseName
      mappingSheet.setColumnWidth(3, 180); // CreateDate
      mappingSheet.setColumnWidth(4, 250); // CreatorId
      mappingSheet.setColumnWidth(5, 150); // CreatorName
      mappingSheet.setColumnWidth(6, 250); // CreatorFullName
      mappingSheet.setColumnWidth(7, 100); // Type
    }
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï UserRegistration
    const creatorFullName = getUserFullName(userId);
    Logger.log("‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡πÑ‡∏î‡πâ: " + creatorFullName);
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const currentDate = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ã‡πâ‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    const existingRow = findExistingZeroClickTracking(mappingSheet, trackingKey);
    if (existingRow > 0) {
      // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
      Logger.log("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà: " + existingRow);
      mappingSheet.getRange(existingRow, 2).setValue(caseName);
      mappingSheet.getRange(existingRow, 3).setValue(currentDate);
      mappingSheet.getRange(existingRow, 4).setValue(userId);
      mappingSheet.getRange(existingRow, 5).setValue(displayName);
      mappingSheet.getRange(existingRow, 6).setValue(creatorFullName);
      mappingSheet.getRange(existingRow, 7).setValue("ZeroClick");
    } else {
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
      Logger.log("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà");
      mappingSheet.appendRow([
        trackingKey, 
        caseName, 
        currentDate, 
        userId, 
        displayName, 
        creatorFullName,
        "ZeroClick"
      ]);
    }
    
    Logger.log(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á ${trackingKey} ‡πÅ‡∏•‡∏∞ ${caseName} ‡πÇ‡∏î‡∏¢ ${creatorFullName} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
    Logger.log("=== saveZeroClickMapping COMPLETED ===");
    return true;
  } catch (error) {
    Logger.log(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå: ${error.message}`);
    Logger.log(`Stack trace: ${error.stack}`);
    return false;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• tracking key ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
function findExistingZeroClickTracking(sheet, trackingKey) {
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  
  for (let i = 1; i < values.length; i++) {
    if (values[i][0] === trackingKey) {
      return i + 1; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏û‡∏ö (‡∏ö‡∏ß‡∏Å 1 ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ index ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà 0)
    }
  }
  
  return 0; // ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Zero Click ‡∏à‡∏≤‡∏Å tracking key
function getZeroClickInfo(trackingKey) {
  try {
    Logger.log("=== getZeroClickInfo STARTED ===");
    Logger.log("trackingKey: " + trackingKey);
    
    if (!trackingKey) {
      Logger.log("trackingKey ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠ null");
      return null;
    }
    
    const spreadsheet = SpreadsheetApp.openById('1j7MqTTEW6izLtVDk95SlPYLjkUqk9MTV7-ZK0Arpnj8');
    const mappingSheet = spreadsheet.getSheetByName('ZeroClickMapping');
    
    if (!mappingSheet) {
      Logger.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï ZeroClickMapping");
      return null;
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï
    const dataRange = mappingSheet.getDataRange();
    const values = dataRange.getValues();
    const headers = values[0];
    
    // ‡∏•‡πá‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    Logger.log("‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á: " + headers.join(", "));
    
    // ‡∏´‡∏≤‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
    const caseIdx = headers.indexOf('CaseName');
    const creatorIdIdx = headers.indexOf('CreatorId');
    const creatorNameIdx = headers.indexOf('CreatorName');
    const creatorFullNameIdx = headers.indexOf('CreatorFullName');
    
    Logger.log("‡∏î‡∏±‡∏ä‡∏ô‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå - CaseName: " + caseIdx + 
               ", CreatorId: " + creatorIdIdx + 
               ", CreatorName: " + creatorNameIdx + 
               ", CreatorFullName: " + creatorFullNameIdx);
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ trackKey ‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå A
    for (let i = 1; i < values.length; i++) {
      if (values[i][0] === trackingKey) {
        const result = {
          trackingKey: trackingKey,
          caseName: values[i][caseIdx !== -1 ? caseIdx : 1] || "ZeroClick",
          createDate: values[i][2] || "",
          creatorId: values[i][creatorIdIdx !== -1 ? creatorIdIdx : 3] || null,
          creatorName: values[i][creatorNameIdx !== -1 ? creatorNameIdx : 4] || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö",
          creatorFullName: values[i][creatorFullNameIdx !== -1 ? creatorFullNameIdx : 5] || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"
        };
        
        Logger.log("‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Zero Click: " + JSON.stringify(result));
        Logger.log("=== getZeroClickInfo COMPLETED ===");
        return result;
      }
    }
    
    Logger.log("‡πÑ‡∏°‡πà‡∏û‡∏ö Tracking Key ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï");
    Logger.log("=== getZeroClickInfo COMPLETED ===");
    return null;
  } catch (error) {
    Logger.log("Error retrieving Zero Click info: " + error);
    Logger.log("Stack trace: " + error.stack);
    return null;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π Zero Click
function createZeroClickViewMessage(data) {
  const timestamp = data.timestamp || new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP
  const ipData = data.ip || {};
  const ip = ipData.ip || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ";
  const location = ipData.city ? `${ipData.city}, ${ipData.region}, ${ipData.country}` : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
  const deviceInfo = data.deviceInfo || {};
  const deviceType = deviceInfo.deviceType || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
  const deviceModel = deviceInfo.deviceModel || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
  const browser = deviceInfo.browser || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  const messageLines = [
    "üö®[Zero Click] ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡∏†‡∏≤‡∏û",
    `‚è∞‡πÄ‡∏ß‡∏•‡∏≤: ${timestamp}`,
  ];
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Case Name ‡πÅ‡∏•‡∏∞ Tracking Key
  if (data.trackingKey) {
    messageLines.push(`üîëTracking Key: ${data.trackingKey}`);
  }
  
  if (data.caseName && data.caseName !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤") {
    messageLines.push(`üìã‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏™: ${data.caseName}`);
  }
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Tracking Key (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (data.creatorFullName && data.creatorFullName !== "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö") {
    messageLines.push(`üë§‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á: ${data.creatorFullName}`);
  }
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP ‡πÅ‡∏•‡∏∞‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
  messageLines.push(
    `\nüåêIP: ${ip}`,
    ` - ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á(IP): ${location}`,
  );
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
  messageLines.push(`\nüíª‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${deviceType} - ${deviceModel}`);
  messageLines.push(`üåê‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå: ${browser}`);
  
  // ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï GPS
  messageLines.push(`\n‚åõ‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS...`);
  
  // ‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢
  messageLines.push(`\n[‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï GPS ‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á]`);
  
  return messageLines.join("\n");
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• GPS ‡∏à‡∏≤‡∏Å Zero Click
function createZeroClickGPSMessage(data) {
  const timestamp = data.timestamp || new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î
  let locationInfo = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ";
  let googleMapsLink = null;
  let gpsAccuracy = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
  
  if (data.location && typeof data.location === 'object' && data.location.lat && data.location.long) {
    locationInfo = `${data.location.lat}, ${data.location.long}`;
    if (data.location.gmapLink) {
      googleMapsLink = data.location.gmapLink;
    } else {
      googleMapsLink = `https://www.google.com/maps?q=${data.location.lat},${data.location.long}`;
    }
    if (data.location.accuracy) {
      gpsAccuracy = `${Math.round(data.location.accuracy)}m`;
    }
  }
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  const messageLines = [
    "üéØ[Zero Click] ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS ‡πÅ‡∏•‡πâ‡∏ß!",
    `‚è∞‡πÄ‡∏ß‡∏•‡∏≤: ${timestamp}`,
  ];
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Case Name ‡πÅ‡∏•‡∏∞ Tracking Key
  if (data.trackingKey) {
    messageLines.push(`üîëTracking Key: ${data.trackingKey}`);
  }
  
  if (data.caseName && data.caseName !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤") {
    messageLines.push(`üìã‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏™: ${data.caseName}`);
  }
  
  // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
  messageLines.push(`\nüìç‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS: ${locationInfo}` + (gpsAccuracy !== "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö" ? ` (‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥¬±${gpsAccuracy})` : ''));
  
  if (googleMapsLink) {
    messageLines.push(`üó∫Ô∏è‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà: ${googleMapsLink}`);
  }
  
  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
  const connectionInfo = (data.deviceInfo && data.deviceInfo.connection) || {};
  const networkType = connectionInfo.networkType || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
  const connectionType = connectionInfo.effectiveType || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
  
  messageLines.push(`\nüì∂‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ${networkType} (${connectionType})`);
  
  return messageLines.join("\n");
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Zero Click
function createZeroClickMessage(data) {
  // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö createZeroClickViewMessage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  return createZeroClickViewMessage(data);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Zero Click ‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE
function sendZeroClickNotification(message, recipientId) {
  try {
    Logger.log("=== sendZeroClickNotification STARTED ===");
    
    const LINE_CHANNEL_TOKEN = 'Y5f04lJbHSrP3Dd1W7ksrBzB9I15XQH8z5Wzm31s/uHqtRV2yGfF/dscvqYrycBmvNjR/L9EUajPTV1CO9V9/KduqLujwCA/9OEX+EFwGH6NXnckX+qLZBZ8K8Y+vHao4EES9XKmG60qzYzeUD4n1AdB04t89/1O/w1cDnyilFU=';
    const LINE_API_ENDPOINT = 'https://api.line.me/v2/bot/message/push';
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ recipientId ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!recipientId || recipientId.trim() === "") {
      Logger.log("recipientId ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô");
      recipientId = "U69aa2cb90c9f40291278c346c50dc021"; // ‡πÉ‡∏ä‡πâ ID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á payload ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö LINE API
    const payload = {
      to: recipientId,
      messages: [{
        type: 'text',
        text: message
      }]
    };
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ options ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö HTTP request
    const options = {
      method: 'post',
      contentType: 'application/json',
      headers: {
        'Authorization': 'Bearer ' + LINE_CHANNEL_TOKEN
      },
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    };
    
    // ‡∏™‡πà‡∏á request ‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE API
    Logger.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á LINE ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: " + recipientId);
    const response = UrlFetchApp.fetch(LINE_API_ENDPOINT, options);
    const responseCode = response.getResponseCode();
    
    if (responseCode >= 200 && responseCode < 300) {
      Logger.log("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Zero Click ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      Logger.log("=== sendZeroClickNotification COMPLETED ===");
      return true;
    } else {
      Logger.log(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Zero Click: HTTP ${responseCode} - ${response.getContentText()}`);
      Logger.log("=== sendZeroClickNotification COMPLETED ===");
      return false;
    }
  } catch (error) {
    Logger.log("Error sending Zero Click notification: " + error.message);
    Logger.log("Stack trace: " + error.stack);
    return false;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Zero Click ‡∏•‡∏á Spreadsheet
function logZeroClickData(data) {
  try {
    Logger.log("=== logZeroClickData STARTED ===");
    
    // ID ‡∏Ç‡∏≠‡∏á Google Spreadsheet ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const spreadsheetId = '1j7MqTTEW6izLtVDk95SlPYLjkUqk9MTV7-ZK0Arpnj8';
    
    // ‡πÄ‡∏õ‡∏¥‡∏î Spreadsheet ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏µ‡∏ó
    const spreadsheet = SpreadsheetApp.openById(spreadsheetId);
    let sheet = spreadsheet.getSheetByName('ZeroClickLog');
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ó‡πÉ‡∏´‡∏°‡πà‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    if (!sheet) {
      Logger.log("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ó ZeroClickLog ‡πÉ‡∏´‡∏°‡πà");
      sheet = spreadsheet.insertSheet('ZeroClickLog');
      
      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      const headers = [
        '‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤', 'Tracking Key', '‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏™', '‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå',
        'IP', '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (IP)', '‡πÄ‡∏°‡∏∑‡∏≠‡∏á (IP)', '‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS', '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà GPS', '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ GPS (m)',
        '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå', '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'RequestId'
      ];
      
      sheet.appendRow(headers);
      
      // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á
      sheet.getRange(1, 1, 1, headers.length)
        .setBackground('#4285f4')
        .setFontColor('#ffffff')
        .setFontWeight('bold');
      
      // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
      sheet.setColumnWidth(1, 180);  // ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤
      sheet.setColumnWidth(2, 200);  // Tracking Key
      sheet.setColumnWidth(3, 250);  // ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏™
      sheet.setColumnWidth(4, 250);  // ‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á
      sheet.setColumnWidth(5, 150);  // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå
      sheet.setColumnWidth(6, 130);  // IP
      sheet.setColumnWidth(7, 100);  // ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (IP)
      sheet.setColumnWidth(8, 120);  // ‡πÄ‡∏°‡∏∑‡∏≠‡∏á (IP)
      sheet.setColumnWidth(9, 150);  // ‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
      sheet.setColumnWidth(10, 250); // ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà GPS
      sheet.setColumnWidth(11, 120); // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥ GPS
      sheet.setColumnWidth(12, 100); // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
      sheet.setColumnWidth(13, 200); // ‡∏£‡∏∏‡πà‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
      sheet.setColumnWidth(14, 150); // ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå
      sheet.setColumnWidth(15, 120); // ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
      sheet.setColumnWidth(16, 250); // RequestId
    }
    
    // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    const timestamp = data.timestamp || new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
    const trackingKey = data.trackingKey || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤";
    const caseName = data.caseName || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤";
    const creatorFullName = data.creatorFullName || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
    const eventType = data.event || "view";
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP
    const ipData = data.ip || {};
    const ip = ipData.ip || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏î‡πâ";
    const country = ipData.country || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
    const city = ipData.city ? `${ipData.city}, ${ipData.region}` : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏¥‡∏Å‡∏±‡∏î GPS
    let gpsLocationText = "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
    let mapLink = "";
    let gpsAccuracy = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
    
    if (data.location && typeof data.location === 'object' && data.location.lat && data.location.long) {
      gpsLocationText = `${data.location.lat}, ${data.location.long}`;
      mapLink = data.location.gmapLink || `https://www.google.com/maps?q=${data.location.lat},${data.location.long}`;
      gpsAccuracy = data.location.accuracy ? `${Math.round(data.location.accuracy)}` : "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
    }
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
    const deviceInfo = data.deviceInfo || {};
    const deviceType = deviceInfo.deviceType || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
    const deviceModel = deviceInfo.deviceModel || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
    const browser = deviceInfo.browser || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    const connectionData = deviceInfo.connection;
    let connectionType = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö";
    
    if (typeof connectionData === 'object') {
      connectionType = `${connectionData.effectiveType || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"} (${connectionData.type || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö"})`;
    }
    
    // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RequestId
    const requestId = data.requestId || "zc-" + new Date().getTime();
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á row ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
    const rowData = [
      timestamp,       // 1
      trackingKey,     // 2 
      caseName,        // 3
      creatorFullName, // 4 
      eventType,       // 5
      ip,              // 6
      country,         // 7
      city,            // 8
      gpsLocationText, // 9
      mapLink,         // 10
      gpsAccuracy,     // 11
      deviceType,      // 12
      deviceModel,     // 13
      browser,         // 14
      connectionType,  // 15
      requestId        // 16
    ];
    
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï
    sheet.appendRow(rowData);
    
    // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Ç‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    const lastRow = sheet.getLastRow();
    
    // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà GPS ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 10)
    if (mapLink && mapLink !== "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•") {
      sheet.getRange(lastRow, 10).setFormula(`=HYPERLINK("${mapLink}","‡∏î‡∏π‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà GPS")`);
    }
    
    Logger.log(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Zero Click ‡∏•‡∏á Spreadsheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${lastRow})`);
    Logger.log("=== logZeroClickData COMPLETED ===");
    
    return true;
  } catch (error) {
    Logger.log(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Zero Click: ${error.message}`);
    Logger.log(`Stack trace: ${error.stack}`);
    return false;
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ç‡∏≠ POST ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
function handleExistingPostRequest(e) {
  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô doPost ‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
  try {
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô doPost ‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏°‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: return originalDoPost(e);
    
    // ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏î‡∏¥‡∏°
    // ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á
    return ContentService.createTextOutput(JSON.stringify({
      status: 'forwarded',
      message: '‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏î‡∏¥‡∏°'
    })).setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    Logger.log("Error in handleExistingPostRequest: " + error.message);
    return ContentService.createTextOutput(JSON.stringify({
      status: 'error',
      message: error.message
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï UserRegistration
function getUserFullName(userId) {
  try {
    Logger.log("=== getUserFullName STARTED ===");
    Logger.log("userId: " + userId);
    
    if (!userId) {
      Logger.log("‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ userId");
      return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ userId)";
    }
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ä‡∏µ‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    const spreadsheet = SpreadsheetApp.openById('1j7MqTTEW6izLtVDk95SlPYLjkUqk9MTV7-ZK0Arpnj8');
    const registrationSheet = spreadsheet.getSheetByName('UserRegistration');
    
    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏µ‡∏ï ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    if (!registrationSheet) {
      Logger.log("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï UserRegistration");
      return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏µ‡∏ï)";
    }
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å‡∏ä‡∏µ‡∏ï
    const dataRange = registrationSheet.getDataRange();
    const values = dataRange.getValues();
    
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ userId ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï
    for (let i = 1; i < values.length; i++) {
      if (values[i][0] === userId) {
        // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 4 (index 3) ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•
        const fullName = values[i][3] || "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏á)";
        Logger.log("‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•: " + fullName);
        Logger.log("=== getUserFullName COMPLETED ===");
        return fullName;
      }
    }
    
    Logger.log("‡πÑ‡∏°‡πà‡∏û‡∏ö userId: " + userId + " ‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï");
    Logger.log("=== getUserFullName COMPLETED ===");
    return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡∏û‡∏ö userId)";
  } catch (error) {
    Logger.log(`‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•: ${error.message}`);
    Logger.log(`Stack trace: ${error.stack}`);
    return "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î)";
  }
}
