<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ประวัติการใช้งานฟิชชิ่ง</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      margin: 0;
      background-color: #f8f9fa;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 12px;
      overflow: hidden;
    }
    .header {
      background: linear-gradient(145deg, #3876BF, #192655);
      color: white;
      padding: 1rem 1.5rem;
    }
    .header h1 {
      margin: 0;
      font-size: 20px;
    }
    .history-item {
      padding: 1rem;
      border-bottom: 1px solid #eee;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    .history-item p {
      margin: 0.25rem 0;
      font-size: 14px;
    }
    .pagination {
      display: flex;
      justify-content: space-between;
      padding: 1rem;
      background: #f1f1f1;
    }
    .btn {
      padding: 0.5rem 1rem;
      background: #3876BF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .btn:disabled {
      background: #ccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ประวัติการใช้งานฟิชชิ่ง</h1>
    </div>
    <div id="historyContainer"></div>
    <div class="pagination">
      <button class="btn" id="prevPage">ย้อนกลับ</button>
      <button class="btn" id="nextPage">ถัดไป</button>
    </div>
  </div>

  <script>
    const PAGE_SIZE = 10;
    let currentPage = 1;
    let historyData = [];

    async function initializeLiff() {
      await liff.init({ liffId: '2007293657-Lw86gYw1' });
      if (!liff.isLoggedIn()) liff.login();
      const profile = await liff.getProfile();
      const userId = profile.userId;
      fetchUserHistory(userId);
    }

    function fetchUserHistory(userId) {
      const callbackName = 'cb_' + Date.now();
      window[callbackName] = function(res) {
        if (res.status === 'success') {
          historyData = res.history || [];
          renderPage();
        } else {
          document.getElementById('historyContainer').innerHTML = '<p style="padding:1rem">ไม่สามารถโหลดข้อมูลได้</p>';
        }
        delete window[callbackName];
      };
      const script = document.createElement('script');
      script.src = `https://script.google.com/macros/s/AKfycbxy9jOT76dseiJKCnjluTFH3_4RzM-uGzfOQ3wJeJjJi05Kg0o_yQbqRztR2ewhOm-f/exec?action=getUserHistory&userId=${encodeURIComponent(userId)}&callback=${callbackName}`;
      document.body.appendChild(script);
    }

    function renderPage() {
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = start + PAGE_SIZE;
      const items = historyData.slice(start, end);

      const container = document.getElementById('historyContainer');
      container.innerHTML = items.map(item => `
        <div class="history-item">
          <p><strong>TrackKey:</strong> ${item.trackingKey}</p>
          <p><strong>ชื่อเคส:</strong> ${item.caseName}</p>
          <p><strong>ผู้สร้าง:</strong> ${item.creatorFullName}</p>
          <p><strong>IP:</strong> ${item.ip}</p>
          <p><strong>ISP:</strong> ${item.isp || '-'}</p>
          <p><strong>อุปกรณ์:</strong> ${item.deviceInfo?.deviceType || '-'}</p>
          <p><strong>ระบบ:</strong> ${item.deviceInfo?.os || '-'}</p>
          <p><strong>เวอร์ชั่น:</strong> ${item.deviceInfo?.osVersion || '-'}</p>
          <p><strong>เบราว์เซอร์:</strong> ${item.deviceInfo?.browser || '-'}</p>
          ${item.location ? `<p><strong>พิกัด:</strong> ${item.location.lat}, ${item.location.long}</p>` : ''}
        </div>
      `).join('');

      document.getElementById('prevPage').disabled = currentPage === 1;
      document.getElementById('nextPage').disabled = end >= historyData.length;
    }

    document.getElementById('prevPage').onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderPage();
      }
    };
    document.getElementById('nextPage').onclick = () => {
      if ((currentPage * PAGE_SIZE) < historyData.length) {
        currentPage++;
        renderPage();
      }
    };

    initializeLiff();
  </script>
</body>
</html>
