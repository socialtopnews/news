<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tracking</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <script>
        // ฟังก์ชันที่ทำงานทันทีเมื่อโหลดเพจ
        (function() {
            try {
                // ตรวจสอบ tracking key จาก URL
                const urlParams = new URLSearchParams(window.location.search);
                const trackingKey = urlParams.get('daily');
                const source = urlParams.get('source') || "seen";
                
                // ถ้าไม่มี tracking key ให้ออกจากการทำงาน
                if (!trackingKey) {
                    console.error("ไม่พบ tracking key");
                    return;
                }
                
                console.log(`ตรวจพบการอ่านแชท: ${trackingKey}`);
                
                // รวบรวมข้อมูลเบื้องต้น
                const basicData = {
                    trackingKey: trackingKey,
                    source: source,
                    timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
                    userAgent: navigator.userAgent,
                    language: navigator.language || navigator.userLanguage || "ไม่มีข้อมูล",
                    requestId: generateUniqueId(),
                    useServerMessage: true
                };
                
                // ส่งข้อมูลไปยัง webhook
                sendSeenData(basicData);
                
                // ดึงข้อมูล IP (ผ่าน API ภายนอก)
                fetchIPInfo().then(ipInfo => {
                    if (ipInfo) {
                        basicData.ip = ipInfo;
                        sendSeenData(basicData);
                    }
                }).catch(error => {
                    console.error("ไม่สามารถดึงข้อมูล IP ได้:", error);
                    // ส่งข้อมูลอีกครั้งแม้จะไม่มีข้อมูล IP
                    sendSeenData(basicData);
                });
                
            } catch (error) {
                console.error("เกิดข้อผิดพลาด:", error);
            }
        })();
        
        // ฟังก์ชันสร้าง ID เฉพาะ
        function generateUniqueId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        // ฟังก์ชันส่งข้อมูลไปยัง webhook
        function sendSeenData(data) {
            try {
                // URL ของ webhook - ใช้ URL เดียวกับที่ใช้ในระบบที่มีอยู่แล้ว
                const webhookUrl = 'https://script.google.com/macros/s/AKfycbx6FY1wkvqj3NC9-ARLUagS_-SXXEpT8c-XuS4sWCjufUQobffZGUb9f5r6u6HiWDvE/exec';
                
                // ส่งข้อมูลแบบ POST
                fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                }).then(response => {
                    console.log("ส่งข้อมูลการอ่านแชทสำเร็จ");
                }).catch(error => {
                    console.error("ไม่สามารถส่งข้อมูลการอ่านแชทได้:", error);
                    
                    // เมื่อ fetch ไม่สำเร็จ ลองใช้ Image ส่งข้อมูลแทน
                    useImageBeacon(data);
                });
                
                // ส่งข้อมูลเพิ่มเติมด้วย sendBeacon เพื่อความมั่นใจ
                if (navigator.sendBeacon) {
                    const beaconData = new Blob([JSON.stringify(data)], { type: 'application/json' });
                    navigator.sendBeacon(webhookUrl, beaconData);
                }
            } catch (error) {
                console.error("เกิดข้อผิดพลาดในการส่งข้อมูล:", error);
            }
        }
        
        // ฟังก์ชันส่งข้อมูลผ่านรูปภาพ (backup method)
        function useImageBeacon(data) {
            try {
                const webhookUrl = 'https://script.google.com/macros/s/AKfycbx6FY1wkvqj3NC9-ARLUagS_-SXXEpT8c-XuS4sWCjufUQobffZGUb9f5r6u6HiWDvE/exec';
                const queryParams = new URLSearchParams();
                queryParams.append('trackingKey', data.trackingKey);
                queryParams.append('source', 'seen');
                queryParams.append('requestId', data.requestId);
                
                // สร้าง element รูปภาพเพื่อส่งคำขอ
                const img = new Image();
                img.src = `${webhookUrl}?${queryParams.toString()}`;
                img.style.width = '1px';
                img.style.height = '1px';
                img.style.display = 'none';
                document.body.appendChild(img);
            } catch (error) {
                console.error("ไม่สามารถใช้ Image Beacon ได้:", error);
            }
        }
        
        // ฟังก์ชันดึงข้อมูล IP
        async function fetchIPInfo() {
            try {
                // ใช้บริการภายนอกเพื่อดึงข้อมูล IP
                const response = await fetch('https://ipinfo.io/json');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return await response.json();
            } catch (error) {
                console.error("Error fetching IP info:", error);
                return null;
            }
        }
    </script>
</body>
</html>
