<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zero Click Image Sharing</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: 'Prompt', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      color: #333;
      line-height: 1.6;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-radius: 10px;
      margin-top: 30px;
    }
    
    h1 {
      color: #06c755;
      text-align: center;
      margin-bottom: 20px;
      font-size: 24px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
      font-family: 'Prompt', sans-serif;
    }
    
    .image-upload {
      border: 2px dashed #06c755;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .image-upload:hover {
      border-color: #048d3b;
      background-color: rgba(6, 199, 85, 0.05);
    }
    
    .image-preview {
      max-width: 100%;
      max-height: 250px;
      margin-top: 15px;
      border-radius: 8px;
      display: none;
    }
    
    .button {
      background-color: #06c755;
      color: white;
      border: none;
      padding: 12px 20px;
      text-align: center;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      font-weight: 500;
      transition: background-color 0.3s ease;
      font-family: 'Prompt', sans-serif;
    }
    
    .button:hover {
      background-color: #048d3b;
    }
    
    .button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .status {
      padding: 15px;
      border-radius: 5px;
      margin-top: 15px;
      text-align: center;
      font-weight: 500;
      display: none;
    }
    
    .success {
      background-color: #d4f8e8;
      color: #06c755;
    }
    
    .error {
      background-color: #ffe5e5;
      color: #ff0000;
    }
    
    .loading {
      display: none;
      text-align: center;
      margin-top: 15px;
    }
    
    .loading img {
      width: 40px;
      height: 40px;
    }
    
    .hidden-file-input {
      display: none;
    }
    
    .tracking-key {
      background-color: #e8f5e9;
      padding: 8px;
      border-radius: 5px;
      font-size: 14px;
      margin-top: 5px;
      word-break: break-all;
      display: none;
    }
    
    .footer {
      text-align: center;
      margin-top: 30px;
      font-size: 12px;
      color: #888;
    }
    
    .progress-container {
      width: 100%;
      background-color: #f1f1f1;
      border-radius: 5px;
      margin-top: 10px;
      display: none;
    }
    
    .progress-bar {
      width: 0;
      height: 20px;
      background-color: #06c755;
      border-radius: 5px;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#06c755" style="vertical-align: middle; margin-right: 8px;">
        <path d="M16 1H8C6.34 1 5 2.34 5 4v16c0 1.66 1.34 3 3 3h8c1.66 0 3-1.34 3-3V4c0-1.66-1.34-3-3-3zm-2 20h-4v-1h4v1zm3.25-3H6.75V4h10.5v14z"/>
      </svg>
      Zero Click Image Sharing
    </h1>
    
    <div class="form-group">
      <label for="caseName">ชื่อเคส:</label>
      <input type="text" id="caseName" placeholder="ระบุชื่อเคสของคุณ" required>
    </div>
    
    <div class="image-upload" id="dropZone">
      <div id="uploadText">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="#06c755">
          <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
        </svg>
        <p>คลิกที่นี่หรือลากรูปภาพมาวาง</p>
        <input type="file" id="fileInput" class="hidden-file-input" accept="image/*">
      </div>
      
      <img id="imagePreview" class="image-preview" alt="รูปภาพตัวอย่าง">
      
      <div id="progressContainer" class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
      </div>
    </div>
    
    <div id="trackingKeyContainer" class="tracking-key"></div>
    
    <button id="shareButton" class="button" disabled>แชร์ไปยังเพื่อนของคุณ</button>
    
    <div id="statusMessage" class="status"></div>
    
    <div class="loading" id="loadingIndicator">
      <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50">
        <path fill="#06c755" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z">
          <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.8s" repeatCount="indefinite"/>
        </path>
      </svg>
    </div>
  </div>
  
  <div class="footer">
    &copy; 2025 Zero Click Image Sharing - ใช้เพื่อการศึกษาและสืบสวนเท่านั้น
  </div>

  <script>
    // เริ่มต้นการทำงานเมื่อโหลดหน้าเว็บ
    document.addEventListener('DOMContentLoaded', () => {
      // ตัวแปรสำหรับเก็บข้อมูลรูปภาพที่อัปโหลด
      let uploadedImage = null;
      let trackingKey = null;
      let userId = null;
      let displayName = null;
      
      // เริ่มต้น LIFF
      initializeLiff();
      
      // ตัวแปรสำหรับอ้างอิงองค์ประกอบใน HTML
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('fileInput');
      const imagePreview = document.getElementById('imagePreview');
      const uploadText = document.getElementById('uploadText');
      const shareButton = document.getElementById('shareButton');
      const caseNameInput = document.getElementById('caseName');
      const statusMessage = document.getElementById('statusMessage');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const trackingKeyContainer = document.getElementById('trackingKeyContainer');
      const progressContainer = document.getElementById('progressContainer');
      const progressBar = document.getElementById('progressBar');
      
      // เพิ่ม event listeners
      dropZone.addEventListener('click', () => fileInput.click());
      
      fileInput.addEventListener('change', handleFileSelect);
      
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#048d3b';
        dropZone.style.backgroundColor = 'rgba(6, 199, 85, 0.1)';
      });
      
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#06c755';
        dropZone.style.backgroundColor = '';
      });
      
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#06c755';
        dropZone.style.backgroundColor = '';
        
        if (e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          handleFileSelect(e);
        }
      });
      
      caseNameInput.addEventListener('input', validateForm);
      
      shareButton.addEventListener('click', shareImage);
      
      // ฟังก์ชันสำหรับเริ่มต้น LIFF
      function initializeLiff() {
        showLoading(true);
        
        liff.init({
          liffId: "YOUR_LIFF_ID" // ต้องเปลี่ยนเป็น LIFF ID ของคุณ
        })
        .then(() => {
          // ตรวจสอบว่าเปิดใน LINE หรือไม่
          if (!liff.isLoggedIn()) {
            liff.login();
          } else {
            // ดึงข้อมูลผู้ใช้
            liff.getProfile()
              .then(profile => {
                userId = profile.userId;
                displayName = profile.displayName;
                showLoading(false);
              })
              .catch(err => {
                console.error("Error getting user profile", err);
                showStatus("เกิดข้อผิดพลาดในการดึงข้อมูลผู้ใช้", false);
                showLoading(false);
              });
          }
        })
        .catch(err => {
          console.error("LIFF initialization failed", err);
          showStatus("ไม่สามารถเริ่มต้น LIFF ได้", false);
          showLoading(false);
        });
      }
      
      // ฟังก์ชันจัดการไฟล์ที่เลือก
      function handleFileSelect(event) {
        const files = fileInput.files || (event.dataTransfer ? event.dataTransfer.files : null);
        
        if (!files || files.length === 0) {
          return;
        }
        
        const file = files[0];
        
        // ตรวจสอบว่าเป็นรูปภาพหรือไม่
        if (!file.type.match('image.*')) {
          showStatus("กรุณาเลือกไฟล์รูปภาพเท่านั้น", false);
          return;
        }
        
        // จำกัดขนาดไฟล์ (5MB)
        if (file.size > 5 * 1024 * 1024) {
          showStatus("ขนาดไฟล์ต้องไม่เกิน 5MB", false);
          return;
        }
        
        uploadedImage = file;
        
        // แสดงตัวอย่างรูปภาพ
        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreview.src = e.target.result;
          imagePreview.style.display = 'block';
          uploadText.style.display = 'none';
        };
        reader.readAsDataURL(file);
        
        // สร้าง tracking key
        generateTrackingKey();
        
        validateForm();
      }
      
      // ฟังก์ชันสร้าง tracking key
      function generateTrackingKey() {
        const timestamp = Date.now().toString(36);
        const randomChars = Math.random().toString(36).substring(2, 6);
        trackingKey = `zc-${timestamp}-${randomChars}`;
        
        trackingKeyContainer.textContent = `Tracking Key: ${trackingKey}`;
        trackingKeyContainer.style.display = 'block';
      }
      
      // ฟังก์ชันตรวจสอบความถูกต้องของฟอร์ม
      function validateForm() {
        const caseName = caseNameInput.value.trim();
        shareButton.disabled = !caseName || !uploadedImage;
      }
      
      // ฟังก์ชันแชร์รูปภาพ
      function shareImage() {
        if (!liff.isApiAvailable('shareTargetPicker')) {
          showStatus("บราวเซอร์นี้ไม่รองรับการแชร์ กรุณาใช้แอพ LINE", false);
          return;
        }
        
        const caseName = caseNameInput.value.trim();
        if (!caseName) {
          showStatus("กรุณาระบุชื่อเคส", false);
          return;
        }
        
        if (!uploadedImage) {
          showStatus("กรุณาเลือกรูปภาพ", false);
          return;
        }
        
        showLoading(true);
        
        // อัปโหลดรูปภาพไปยังเซิร์ฟเวอร์
        uploadImageToServer(caseName)
          .then(imageUrl => {
            // สร้าง message สำหรับ share target picker
            const message = {
              "type": "image",
              "originalContentUrl": imageUrl,
              "previewImageUrl": imageUrl
            };
            
            // แสดง share target picker
            liff.shareTargetPicker([message])
              .then(result => {
                if (result) {
                  showStatus("แชร์รูปภาพสำเร็จ!", true);
                  
                  // รีเซ็ตฟอร์ม
                  setTimeout(() => {
                    resetForm();
                  }, 2000);
                } else {
                  showStatus("ยกเลิกการแชร์", false);
                }
                showLoading(false);
              })
              .catch(err => {
                console.error("Error in sharing", err);
                showStatus("เกิดข้อผิดพลาดในการแชร์", false);
                showLoading(false);
              });
          })
          .catch(err => {
            console.error("Error uploading image", err);
            showStatus("เกิดข้อผิดพลาดในการอัปโหลดรูปภาพ", false);
            showLoading(false);
          });
      }
      
      // ฟังก์ชันอัปโหลดรูปภาพไปยังเซิร์ฟเวอร์
      function uploadImageToServer(caseName) {
        return new Promise((resolve, reject) => {
          const formData = new FormData();
          formData.append('image', uploadedImage);
          formData.append('trackingKey', trackingKey);
          formData.append('caseName', caseName);
          formData.append('userId', userId);
          formData.append('displayName', displayName);
          formData.append('type', 'zeroclick');
          
          // แสดง progress bar
          progressContainer.style.display = 'block';
          
          // สร้าง XMLHttpRequest สำหรับการอัปโหลด
          const xhr = new XMLHttpRequest();
          
          // ติดตามความก้าวหน้าการอัปโหลด
          xhr.upload.addEventListener('progress', (event) => {
            if (event.lengthComputable) {
              const percentComplete = (event.loaded / event.total) * 100;
              progressBar.style.width = percentComplete + '%';
            }
          });
          
          xhr.addEventListener('load', () => {
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const response = JSON.parse(xhr.responseText);
                resolve(response.imageUrl);
              } catch (e) {
                reject(new Error('การตอบกลับจากเซิร์ฟเวอร์ไม่ถูกต้อง'));
              }
            } else {
              reject(new Error('อัปโหลดไม่สำเร็จ: ' + xhr.statusText));
            }
          });
          
          xhr.addEventListener('error', () => {
            reject(new Error('เกิดข้อผิดพลาดในการเชื่อมต่อ'));
          });
          
          xhr.addEventListener('abort', () => {
            reject(new Error('การอัปโหลดถูกยกเลิก'));
          });
          
          // ตั้งค่าและส่งคำขอ
          xhr.open('POST', 'https://script.google.com/macros/s/YOUR_WEB_APP_ID/exec');
          xhr.send(formData);
          
          // หมายเหตุ: ต้องแทนที่ YOUR_WEB_APP_ID ด้วย ID ของ Google Web App ของคุณ
        });
      }
      
      // ฟังก์ชันแสดงสถานะ
      function showStatus(message, isSuccess) {
        statusMessage.textContent = message;
        statusMessage.className = 'status ' + (isSuccess ? 'success' : 'error');
        statusMessage.style.display = 'block';
        
        // ซ่อนสถานะหลังจาก 5 วินาที
        setTimeout(() => {
          statusMessage.style.display = 'none';
        }, 5000);
      }
      
      // ฟังก์ชันแสดง/ซ่อนตัวบ่งชี้การโหลด
      function showLoading(show) {
        loadingIndicator.style.display = show ? 'block' : 'none';
      }
      
      // ฟังก์ชันรีเซ็ตฟอร์ม
      function resetForm() {
        caseNameInput.value = '';
        uploadedImage = null;
        trackingKey = null;
        imagePreview.style.display = 'none';
        imagePreview.src = '';
        uploadText.style.display = 'block';
        trackingKeyContainer.style.display = 'none';
        shareButton.disabled = true;
        progressContainer.style.display = 'none';
        progressBar.style.width = '0';
        fileInput.value = '';
      }
    });
  </script>
</body>
</html>
